<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malik Service Center</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --light-bg: #f8fafc;
            --light-card: #ffffff;
            --text-main: #334155;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        body.dark-mode {
            --light-bg: #0f172a;
            --light-card: #1e293b;
            --text-main: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--light-bg);
            color: var(--text-main);
            transition: var(--transition);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            background: var(--light-card);
            padding: 1rem 5%;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        /* MAIN CONTAINER */
        main { max-width: 600px; margin: 2rem auto; padding: 0 1.5rem; flex: 1; }

        /* SECTIONS */
        .step-section {
            background: var(--light-card);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-bottom: 1.5rem; color: var(--primary); font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        p.subtitle { color: var(--text-light); margin-bottom: 2rem; font-size: 0.95rem; }

        /* FORMS */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        input[type="text"], input[type="password"], input[type="tel"], input[type="date"], select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--light-bg); color: var(--text-main); font-size: 1rem;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        /* Readonly style */
        input[readonly] {
            background-color: #e2e8f0;
            color: #64748b;
            cursor: default;
        }

        /* BUTTONS */
        .btn { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-secondary:hover { background: #475569; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-whatsapp:hover { background: #1ebc57; }
        .btn-success { background: var(--secondary); color: white; }
        
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 2rem; gap: 1rem; }
        .full-width { width: 100%; margin-bottom: 10px; }

        /* HERO SPECIFIC */
        .hero-section { text-align: center; padding: 2rem 1.5rem; }
        .hero-icon { font-size: 3rem; color: var(--primary); margin-bottom: 1rem; }
        .cta-btn { background: var(--primary); color: white; padding: 1rem 2rem; border: none; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 1rem; }
        
        /* ADMIN RECEIPT STYLES */
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .full-col { grid-column: span 2; }
        
        /* PRICE SUMMARY BOX (New Feature) */
        .price-summary {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none; /* Hidden by default until selection */
            animation: fadeIn 0.3s;
        }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .price-total { border-top: 1px solid rgba(255,255,255,0.3); margin-top: 8px; padding-top: 8px; font-weight: bold; font-size: 1.1rem; display: flex; justify-content: space-between; }

        /* PRINT PREVIEW / RECEIPT CARD */
        #receiptPreview {
            background: white; color: black; width: 100%; max-width: 380px;
            padding: 20px; font-family: 'Courier New', Courier, monospace;
            border: 1px solid #ccc; margin: 20px auto; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: block;
        }
        
        .receipt-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
        .receipt-logo { 
            font-size: 2.5rem; 
            color: #2563eb !important;
            display: inline-block; 
            margin-bottom: 5px; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact; 
        }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .receipt-divider { border-top: 2px dashed #000; margin: 15px 0; }
        .receipt-total { font-weight: bold; font-size: 1.1rem; display: flex; justify-content: space-between; }

        /* TOAST */
        .toast { position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 1rem; border-radius: 8px; z-index: 200; display: none; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* PRINT MEDIA */
        @media print {
            body * { visibility: hidden; }
            #receiptPreview, #receiptPreview * { visibility: visible; }
            #receiptPreview { position: absolute; left: 0; top: 0; width: 100%; max-width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; color: black !important; }
            .no-print { display: none !important; }
        }

        /* Responsive */
        @media(max-width: 480px) { .admin-grid { grid-template-columns: 1fr; } .full-col { grid-column: span 1; } }
    </style>
</head>
<body>

    <header>
        <div class="brand"><i class="fa-solid fa-screwdriver-wrench"></i> Malik Service</div>
        <button id="darkModeBtn" style="background:none; border:none; color:var(--text-main); cursor:pointer;"><i class="fa-solid fa-moon"></i></button>
    </header>

    <div id="toast" class="toast"></div>

    <main>
        <!-- 1. LOGIN ADMIN -->
        <section id="login-section" class="step-section active">
            <h2><i class="fa-solid fa-lock"></i> Login Admin</h2>
            <p class="subtitle">Masuk untuk membuat Resi Manual. (Cek via Spreadsheet)</p>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="adminUser" placeholder="Masukan username">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="adminPass" placeholder="Masukan password">
            </div>
            <!-- ID btnLogin ditambahkan untuk manipulasi loading -->
            <button id="btnLogin" class="btn btn-primary full-width" onclick="handleLogin()">
                <span>Masuk Panel Admin</span>
            </button>
            <button class="btn btn-secondary full-width" onclick="goToCustomerView()">Ke Halaman Pelanggan (Order Biasa)</button>
        </section>

        <!-- 2. ADMIN PANEL -->
        <section id="admin-panel" class="step-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 style="margin:0;"><i class="fa-solid fa-file-invoice"></i> Buat Resi Manual</h2>
                <button class="btn btn-secondary" onclick="logout()" style="padding:5px 10px; font-size:0.8rem;">Keluar</button>
            </div>
            
            <div class="admin-grid">
                <div class="form-group full-col">
                    <label>Nomor Order / Resi</label>
                    <!-- Added readonly attribute -->
                    <input type="text" id="resOrderId" placeholder="Otomatis saat Login" readonly>
                </div>
                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="resDate" onchange="updateLivePreview()">
                </div>
                <div class="form-group">
                    <label>Nama Pelanggan</label>
                    <input type="text" id="resName" placeholder="Nama Customer" oninput="updateLivePreview()">
                </div>
                <div class="form-group">
                    <label>No. HP / WA</label>
                    <input type="text" id="resWA" placeholder="08..." oninput="updateLivePreview()">
                </div>
                <div class="form-group">
                    <label>Perangkat</label>
                    <input type="text" id="resDevice" placeholder="HP/Laptop" oninput="updateLivePreview()">
                </div>
                <div class="form-group">
                    <label>Merek/Model</label>
                    <input type="text" id="resModel" placeholder="Samsung A52" oninput="updateLivePreview()">
                </div>
                <div class="form-group full-col">
                    <label>Keluhan / Kerusakan</label>
                    <textarea id="resIssue" rows="2" placeholder="Deskripsi kerusakan..." oninput="updateLivePreview()"></textarea>
                </div>
                <div class="form-group full-col">
                    <label>Layanan & Biaya ( Manual Entry )</label>
                    <textarea id="resServices" rows="3" placeholder="Ganti LCD - 500000&#10;Ganti Baterai - 250000" oninput="updateLivePreview()"></textarea>
                </div>
            </div>

            <div style="margin-top: 2rem; display: flex; flex-direction: column; gap: 10px;">
                <button class="btn btn-primary full-width" onclick="printReceipt()">
                    <i class="fa-solid fa-print"></i> Cetak Resi (Printer)
                </button>
                <button id="btnDownload" class="btn btn-success full-width" onclick="downloadReceiptImage()">
                    <i class="fa-solid fa-download"></i> Download Resi (Gambar PNG)
                </button>
            </div>

            <div class="receipt-divider"></div>
            <h4 style="text-align:center; color:var(--text-light);">Preview Tampilan:</h4>
            
            <div id="receiptPreview">
                <div class="receipt-header">
                    <i class="fa-solid fa-screwdriver-wrench receipt-logo"></i>
                    <div style="font-weight:bold; font-size:1.2rem; text-transform:uppercase;">MALIK SERVICE</div>
                    <div style="font-size:0.8rem;"> DS.JamalSari RT004/RW002 No.52 Jl.Untung Suropati, Kota Semarang </div>
                    <div style="font-size:0.8rem;">WA: 0857-1308-7659</div>
                </div>
                <div class="receipt-row"><span>No. Order:</span><span id="prevId">-</span></div>
                <div class="receipt-row"><span>Tanggal:</span><span id="prevDate">-</span></div>
                <div class="receipt-divider"></div>
                <div class="receipt-row"><span>Pelanggan:</span><span id="prevName">-</span></div>
                <div class="receipt-row"><span>No. HP:</span><span id="prevWA">-</span></div>
                <div class="receipt-divider"></div>
                <div class="receipt-row"><span>Perangkat:</span><span id="prevDevice">-</span></div>
                <div class="receipt-row"><span>Model:</span><span id="prevModel">-</span></div>
                <div class="receipt-row" style="flex-direction:column;">
                    <span style="font-weight:bold; margin-bottom:2px;">Keluhan:</span>
                    <span id="prevIssue" style="font-size:0.8rem; text-align:right;">-</span>
                </div>
                <div class="receipt-divider"></div>
                <div style="font-weight:bold; margin-bottom:5px;">Rincian Layanan:</div>
                <div id="prevServices">
                    <div style="font-size:0.8rem; text-align:center;">Belum ada data</div>
                </div>
                <div class="receipt-divider"></div>
                <div class="receipt-total">
                    <span>TOTAL:</span>
                    <span id="prevTotal">Rp 0</span>
                </div>
                <div class="receipt-footer" style="text-align:center; margin-top:15px; font-size:0.7rem;">
                    <p>*Simpan struk ini sebagai bukti garansi.</p>
                    <p>Terima Kasih</p>
                </div>
            </div>
        </section>

        <!-- 3. CUSTOMER ORDER HERO -->
        <section id="customer-hero" class="step-section hero-section">
            <i class="fa-solid fa-microchip hero-icon"></i>
            <h1>Malik Service Center</h1>
            <p class="subtitle">Solusi perbaikan HP, Laptop & Elektronik Terpercaya.</p>
            
            <button class="cta-btn" onclick="startCustomerOrder()">
                Buat Order Servis Sekarang <i class="fa-solid fa-arrow-right"></i>
            </button>
            <button class="btn btn-secondary full-width" onclick="showLogin()">
                <i class="fa-solid fa-lock"></i> Login Admin (Area Khusus)
            </button>
        </section>
        
        <!-- 4. FORM ORDER PELANGGAN (UPDATED WITH DATABASE) -->
        <section id="customer-form" class="step-section">
            <h2><i class="fa-solid fa-wrench"></i> Detail Kerusakan</h2>
            <p class="subtitle">Pilih jenis perangkat dan kerusakan untuk estimasi biaya.</p>

            <!-- DATABASE SELECTION -->
            <div class="form-group">
                <label>Kategori Perangkat</label>
                <select id="custCategory" onchange="populateServiceDropdown()">
                    <option value="">-- Pilih Kategori --</option>
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div class="form-group">
                <label>Komponen & Kerusakan</label>
                <select id="custService" onchange="updatePriceSummary()">
                    <option value="">-- Pilih Kerusakan --</option>
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- PRICE SUMMARY DISPLAY -->
            <div id="priceDisplay" class="price-summary">
                <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">Rincian Biaya:</div>
                <div class="price-row">
                    <span>Harga Sparepart:</span>
                    <span id="dispSparepart">Rp 0</span>
                </div>
                <div class="price-row">
                    <span>Biaya Jasa:</span>
                    <span id="dispService">Rp 0</span>
                </div>
                <div class="price-total">
                    <span>ESTIMASI TOTAL:</span>
                    <span id="dispTotal">Rp 0</span>
                </div>
                <div style="font-size:0.75rem; margin-top:8px; font-style:italic;">*Harga bisa berubah setelah pengecekan fisik.</div>
            </div>

            <div class="receipt-divider" style="margin: 20px 0;"></div>
            
            <h2><i class="fa-solid fa-user"></i> Data Diri</h2>
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" id="custName" placeholder="Contoh: Budi Santoso">
            </div>
            <div class="form-group">
                <label>Nomor WhatsApp</label>
                <input type="tel" id="custWA" placeholder="0812...">
            </div>
            <div class="form-group">
                <label>Alamat / Detail Lokasi</label>
                <textarea id="custAddress" rows="2" placeholder="Alamat lengkap..."></textarea>
            </div>

            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="goToCustomerView()">Batal</button>
                <!-- ID btnSendWA ditambahkan agar bisa diberi efek loading saat simpan data -->
                <button id="btnSendWA" class="btn btn-whatsapp" onclick="sendCustomerOrder(event)">
                    <i class="fa-brands fa-whatsapp"></i> Kirim Order ke WA
                </button>
            </div>
        </section>

    </main>

    <!-- Library html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        // ==========================================
        // KONFIGURASI BACKEND SPREADSHEET
        // ==========================================
        // 1. Link Google Sheets (CSV) untuk cek LOGIN
        const SPREADSHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMPwDhdP3zSLLz_VZrOUeLzWImUq2_aoc06Pwwe_t-5UAEBDnmClxXZ3FjJGm-p7bDFznhQ2CF74me/pub?gid=0&single=true&output=csv"; 

        // 2. URL APPS SCRIPT untuk SIMPAN ORDER (Disiapkan oleh User)
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxIVdXLb9UPX2LbG9wMe5eb_-W0rhxRGJF-TMbxgeNjH07UQI6j3AAW3ROBlc-9mmRU/exec";

        // ==========================================
        // 1. DATABASE LAYANAN (DATA DARI USER)
        // ==========================================
        const serviceDatabase = [
            { cat: "HP", comp: "LCD", issue: "Layar pecah / blank", sparepart: 250000, jasa: 80000 },
            { cat: "HP", comp: "Touchscreen", issue: "Sentuh tidak responsif", sparepart: 150000, jasa: 70000 },
            { cat: "HP", comp: "Baterai", issue: "Drop / tidak mengisi", sparepart: 120000, jasa: 50000 },
            { cat: "HP", comp: "Konektor Cas", issue: "Tidak bisa charging", sparepart: 80000, jasa: 50000 },
            { cat: "HP", comp: "Speaker", issue: "Suara kecil / mati", sparepart: 60000, jasa: 50000 },
            { cat: "HP", comp: "Mic", issue: "Tidak bisa telpon", sparepart: 50000, jasa: 50000 },
            { cat: "HP", comp: "Kamera", issue: "Kamera blur / mati", sparepart: 90000, jasa: 60000 },
            { cat: "HP", comp: "Flex Volume", issue: "Tombol rusak", sparepart: 40000, jasa: 50000 },
            { cat: "HP", comp: "Flex Power", issue: "HP tidak bisa nyala", sparepart: 40000, jasa: 60000 },
            { cat: "HP", comp: "IC Power", issue: "Mati total", sparepart: 180000, jasa: 150000 },
            { cat: "Laptop", comp: "LCD Laptop", issue: "Layar pecah / garis", sparepart: 550000, jasa: 150000 },
            { cat: "Laptop", comp: "Keyboard", issue: "Tombol mati", sparepart: 300000, jasa: 120000 },
            { cat: "Laptop", comp: "Baterai Laptop", issue: "Tidak mengisi", sparepart: 350000, jasa: 120000 },
            { cat: "Laptop", comp: "SSD 256GB", issue: "Upgrade / rusak", sparepart: 400000, jasa: 100000 },
            { cat: "Laptop", comp: "HDD 1TB", issue: "Bad sector", sparepart: 450000, jasa: 100000 },
            { cat: "Laptop", comp: "Fan Laptop", issue: "Panas / berisik", sparepart: 120000, jasa: 100000 },
            { cat: "Laptop", comp: "Thermal Paste", issue: "Overheat", sparepart: 30000, jasa: 80000 },
            { cat: "Laptop", comp: "Engsel", issue: "Patah", sparepart: 150000, jasa: 120000 },
            { cat: "Laptop", comp: "Charger", issue: "Tidak mengisi", sparepart: 180000, jasa: 50000 },
            { cat: "PC", comp: "Motherboard", issue: "Mati total", sparepart: 700000, jasa: 150000 },
            { cat: "PC", comp: "RAM 8GB", issue: "Tidak booting", sparepart: 300000, jasa: 50000 },
            { cat: "PC", comp: "SSD 512GB", issue: "Upgrade / rusak", sparepart: 650000, jasa: 100000 },
            { cat: "PC", comp: "Power Supply", issue: "PC mati", sparepart: 400000, jasa: 120000 },
            { cat: "PC", comp: "VGA Card", issue: "No display", sparepart: 1500000, jasa: 150000 },
            { cat: "PC", comp: "CPU Cooler", issue: "Overheat", sparepart: 150000, jasa: 80000 },
            { cat: "PC", comp: "Fan Case", issue: "Sirkulasi udara", sparepart: 50000, jasa: 50000 },
            { cat: "Kulkas", comp: "Thermostat", issue: "Tidak dingin", sparepart: 150000, jasa: 120000 },
            { cat: "Kulkas", comp: "Timer Defrost", issue: "Bunga es", sparepart: 180000, jasa: 120000 },
            { cat: "Kulkas", comp: "Fan Motor", issue: "Tidak dingin merata", sparepart: 200000, jasa: 150000 },
            { cat: "Kulkas", comp: "Kapasitor", issue: "Mesin tidak start", sparepart: 70000, jasa: 100000 },
            { cat: "Kulkas", comp: "Relay", issue: "Kompresor mati", sparepart: 90000, jasa: 120000 },
            { cat: "Kulkas", comp: "Karet Pintu", issue: "Bocor dingin", sparepart: 80000, jasa: 80000 },
            { cat: "Kulkas", comp: "Kompresor", issue: "Mati total", sparepart: 900000, jasa: 300000 },
            { cat: "Mesin Cuci", comp: "Dinamo", issue: "Tidak berputar", sparepart: 450000, jasa: 200000 },
            { cat: "Mesin Cuci", comp: "Kapasitor", issue: "Putaran lemah", sparepart: 70000, jasa: 100000 },
            { cat: "Mesin Cuci", comp: "Timer", issue: "Tidak jalan", sparepart: 120000, jasa: 120000 },
            { cat: "Mesin Cuci", comp: "Vanbelt", issue: "Putus", sparepart: 50000, jasa: 80000 },
            { cat: "Mesin Cuci", comp: "Gearbox", issue: "Suara kasar", sparepart: 350000, jasa: 180000 },
            { cat: "Mesin Cuci", comp: "Seal Tabung", issue: "Bocor", sparepart: 90000, jasa: 150000 },
            { cat: "Mesin Cuci", comp: "Pompa Air", issue: "Tidak buang air", sparepart: 150000, jasa: 150000 },
            { cat: "TV", comp: "LED Backlight", issue: "Gelap", sparepart: 300000, jasa: 150000 },
            { cat: "TV", comp: "Power Supply Board", issue: "Tidak nyala", sparepart: 350000, jasa: 150000 },
            { cat: "TV", comp: "Mainboard", issue: "No signal", sparepart: 600000, jasa: 180000 },
            { cat: "TV", comp: "T-Con Board", issue: "Garis layar", sparepart: 250000, jasa: 150000 },
            { cat: "TV", comp: "Speaker TV", issue: "Suara pecah", sparepart: 80000, jasa: 80000 },
            { cat: "TV", comp: "Panel LCD", issue: "Retak", sparepart: 1200000, jasa: 250000 },
            { cat: "Kipas Angin", comp: "Dinamo", issue: "Tidak berputar", sparepart: 180000, jasa: 80000 },
            { cat: "Kipas Angin", comp: "Kapasitor", issue: "Putaran lemah", sparepart: 40000, jasa: 50000 },
            { cat: "Kipas Angin", comp: "Baling-baling", issue: "Patah", sparepart: 50000, jasa: 50000 },
            { cat: "Kipas Angin", comp: "Switch", issue: "Tidak bisa pindah speed", sparepart: 30000, jasa: 50000 },
            { cat: "Kipas Angin", comp: "Bearing", issue: "Berisik", sparepart: 40000, jasa: 60000 },
            { cat: "Jasa Servis", comp: "Cek & Diagnosa", issue: "Semua perangkat", sparepart: 0, jasa: 50000 },
            { cat: "Jasa Servis", comp: "Cleaning Dalam", issue: "HP / Laptop / PC", sparepart: 0, jasa: 80000 },
            { cat: "Jasa Servis", comp: "Install OS", issue: "Laptop / PC", sparepart: 0, jasa: 100000 },
            { cat: "Jasa Servis", comp: "Flushing Kulkas", issue: "Kulkas tidak dingin", sparepart: 0, jasa: 250000 },
            { cat: "Jasa Servis", comp: "Servis Dinamo", issue: "Mesin Cuci / Kipas", sparepart: 0, jasa: 150000 },
            { cat: "HP", comp: "IC Charging", issue: "Tidak bisa isi daya", sparepart: 120000, jasa: 120000 },
            { cat: "HP", comp: "IC Audio", issue: "Suara mati", sparepart: 100000, jasa: 120000 },
            { cat: "HP", comp: "IC RF", issue: "Sinyal hilang", sparepart: 150000, jasa: 150000 },
            { cat: "HP", comp: "Antena Signal", issue: "Sinyal lemah", sparepart: 30000, jasa: 50000 },
            { cat: "HP", comp: "SIM Tray", issue: "SIM tidak terbaca", sparepart: 20000, jasa: 30000 },
            { cat: "HP", comp: "Vibrator", issue: "Getar tidak jalan", sparepart: 25000, jasa: 40000 },
            { cat: "HP", comp: "Back Cover", issue: "Cover pecah", sparepart: 50000, jasa: 30000 },
            { cat: "HP", comp: "Proximity Sensor", issue: "Layar mati saat telpon", sparepart: 40000, jasa: 60000 },
            { cat: "HP", comp: "Gyro Sensor", issue: "Auto rotate error", sparepart: 60000, jasa: 70000 },
            { cat: "HP", comp: "Face ID / Fingerprint", issue: "Tidak terbaca", sparepart: 120000, jasa: 80000 },
            { cat: "HP", comp: "Camera Flex", issue: "Kamera tidak terdeteksi", sparepart: 60000, jasa: 60000 },
            { cat: "HP", comp: "Loudspeaker", issue: "Bunyi pecah", sparepart: 70000, jasa: 50000 },
            { cat: "HP", comp: "IC Display", issue: "Layar blank", sparepart: 200000, jasa: 180000 },
            { cat: "HP", comp: "Flash HP Normal", issue: "Error sistem", sparepart: 0, jasa: 50000 },
            { cat: "HP", comp: "Flash HP + FRP", issue: "Lupa akun Google", sparepart: 0, jasa: 80000 },
            { cat: "HP", comp: "Flash HP Deadboot", issue: "Mati software", sparepart: 0, jasa: 120000 }
        ];

        // --- 2. HELPER FUNCTIONS ---
        function formatRupiah(number) {
            return "Rp " + number.toLocaleString('id-ID');
        }

        // --- 3. NAVIGATION & LOGIC ---
        function showSection(id) {
            document.querySelectorAll('.step-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        function showLogin() { showSection('login-section'); }
        function goToCustomerView() { 
            showSection('customer-hero'); 
            // Reset form when going back
            document.getElementById('custCategory').value = "";
            document.getElementById('custService').innerHTML = '<option value="">-- Pilih Kerusakan --</option>';
            document.getElementById('priceDisplay').style.display = 'none';
            document.getElementById('custName').value = '';
            document.getElementById('custWA').value = '';
            document.getElementById('custAddress').value = '';
        }
        function startCustomerOrder() { 
            showSection('customer-form'); 
            populateCategories(); 
        }

        // --- 4. DATABASE LOGIC ---
        
        // Isi dropdown Kategori
        function populateCategories() {
            const catSelect = document.getElementById('custCategory');
            // Ambil kategori unik dari database
            const categories = [...new Set(serviceDatabase.map(item => item.cat))];
            
            // Jangan hapus opsi pertama ("-- Pilih --"), tapi sisanya hapus
            while (catSelect.options.length > 1) {
                catSelect.remove(1);
            }

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                catSelect.appendChild(option);
            });
        }

        // Isi dropdown Layanan berdasarkan Kategori
        function populateServiceDropdown() {
            const selectedCat = document.getElementById('custCategory').value;
            const servSelect = document.getElementById('custService');
            const priceDisplay = document.getElementById('priceDisplay');

            // Reset service select
            servSelect.innerHTML = '<option value="">-- Pilih Kerusakan --</option>';
            priceDisplay.style.display = 'none';

            if (!selectedCat) return;

            // Filter database berdasarkan kategori
            const filteredServices = serviceDatabase.filter(item => item.cat === selectedCat);

            filteredServices.forEach(item => {
                const option = document.createElement('option');
                // Simpan index atau data di value agar mudah dipanggil nanti
                // Kita stringify object JSON agar semua data tersimpan
                option.value = JSON.stringify(item); 
                // Tampilan: Komponen - Jenis Kerusakan (Total)
                option.textContent = `${item.comp} - ${item.issue}`;
                servSelect.appendChild(option);
            });
        }

        // Update Tampilan Harga saat kerusakan dipilih
        function updatePriceSummary() {
            const servSelect = document.getElementById('custService');
            const priceDisplay = document.getElementById('priceDisplay');
            
            if (servSelect.value === "") {
                priceDisplay.style.display = 'none';
                return;
            }

            const data = JSON.parse(servSelect.value);
            const total = data.sparepart + data.jasa;

            document.getElementById('dispSparepart').textContent = formatRupiah(data.sparepart);
            document.getElementById('dispService').textContent = formatRupiah(data.jasa);
            document.getElementById('dispTotal').textContent = formatRupiah(total);

            priceDisplay.style.display = 'block';
        }

        // --- 5. WA SENDING & SPREADSHEET LOGIC (UPDATED) ---
        async function sendCustomerOrder(event) {
            // Mencegah double click jika tombol tidak disabled
            if(event) event.preventDefault();

            const btn = document.getElementById('btnSendWA');
            const originalBtnContent = btn.innerHTML;

            const name = document.getElementById('custName').value;
            const wa = document.getElementById('custWA').value;
            const address = document.getElementById('custAddress').value;

            if (!name || !wa) {
                showToast("Nama dan Nomor WA wajib diisi!");
                return;
            }

            const servSelect = document.getElementById('custService');
            let messageBody = "";
            let serviceData = {
                cat: "-",
                comp: "-",
                issue: "Konsultasi Umum",
                total: "0"
            };

            if (servSelect.value !== "") {
                const data = JSON.parse(servSelect.value);
                const total = data.sparepart + data.jasa;
                serviceData = {
                    cat: data.cat,
                    comp: data.comp,
                    issue: data.issue,
                    total: total
                };

                messageBody =
`Halo Admin, saya ingin order servis.

DETAIL KERUSAKAN:
Kategori: ${data.cat}
Komponen: ${data.comp}
Masalah: ${data.issue}

ESTIMASI BIAYA:
Sparepart: ${formatRupiah(data.sparepart)}
Jasa: ${formatRupiah(data.jasa)}
TOTAL: ${formatRupiah(total)}

DATA PELANGGAN:
Nama: ${name}
No WA: ${wa}
Alamat: ${address}`;
            } else {
                messageBody =
`Halo Admin, saya ingin konsultasi servis.

Nama: ${name}
No WA: ${wa}
Alamat: ${address}`;
            }

            // 1. Set Loading UI
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan Data...';

            // 2. Siapkan Data untuk Spreadsheet
            const payload = {
                name: name,
                wa: wa,
                address: address,
                cat: serviceData.cat,
                comp: serviceData.comp,
                issue: serviceData.issue,
                total: serviceData.total
            };

            try {
                // 3. Kirim ke Google Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error("Gagal koneksi ke database");
                }

                const result = await response.json();
                
                // 4. Jika Sukses Simpan, Buka WhatsApp
                showToast("Data berhasil disimpan!", true);
                setTimeout(() => {
                    openWhatsApp("6285713087659", messageBody);
                }, 1000); // Jeda sebentar agar user melihat notifikasi sukses

            } catch (error) {
                console.error("Error:", error);
                // Jika gagal simpan database, tetap buat WA agar order tidak hilang
                showToast("Gagal simpan ke Database, tapi tetap kirim ke WA.", false);
                setTimeout(() => {
                    openWhatsApp("6285713087659", messageBody);
                }, 1500);
            } finally {
                // 5. Reset Tombol
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
            }
        }

        // --- 6. LOGIN & SECURITY LOGIC (BACKEND SPREADSHEET) ---
        async function handleLogin() {
            const user = document.getElementById('adminUser').value.trim();
            const pass = document.getElementById('adminPass').value.trim();
            const btn = document.getElementById('btnLogin');

            if (!user || !pass) {
                showToast("Username dan Password wajib diisi!");
                return;
            }

            // Set loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengecek Data...';

            try {
                // Ambil data dari Google Sheets
                const response = await fetch(SPREADSHEET_URL);
                if (!response.ok) throw new Error("Gagal mengambil data");
                
                const csvData = await response.text();
                const isValid = validateCredentials(csvData, user, pass);

                if (isValid) {
                    showToast("Login Berhasil", true);
                    
                    // Set tanggal hari ini
                    document.getElementById('resDate').valueAsDate = new Date();
                    
                    // --- GENERATE NOMOR RESI OTOMATIS ---
                    document.getElementById('resOrderId').value = generateOrderId();
                    
                    updateLivePreview();
                    showSection('admin-panel');
                } else {
                    showToast("Username atau Password salah!");
                }

            } catch (error) {
                console.error(error);
                showToast("Gagal koneksi ke server login.");
            } finally {
                // Reset loading state
                btn.disabled = false;
                btn.innerHTML = '<span>Masuk Panel Admin</span>';
            }
        }

        // --- BARU: Fungsi Generate Order ID ---
        function generateOrderId() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            
            // Format: ORD-YYYYMMDD-HHMMSS
            return `ORD-${yyyy}${mm}${dd}-${hh}${min}${ss}`;
        }

        // Fungsi untuk mem-parsing CSV dan mengecek login
        function validateCredentials(csvText, inputUser, inputPass) {
            const rows = csvText.split('\n');
            // Mulai dari index 1 karena index 0 adalah header
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].trim();
                if (!row) continue; // Lewati baris kosong

                const cols = row.split(',');
                
                if (cols.length >= 2) {
                    const dbUser = cols[0].trim();
                    const dbPass = cols[1].trim();

                    if (dbUser === inputUser && dbPass === inputPass) {
                        return true;
                    }
                }
            }
            return false;
        }

        function logout() {
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
            showSection('login-section');
            showToast("Anda telah keluar", true);
        }

        function showToast(msg, isSuccess = false) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.background = isSuccess ? '#10b981' : '#ef4444';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        function updateLivePreview() {
            const id = document.getElementById('resOrderId').value || '-';
            const date = document.getElementById('resDate').value || '-';
            const name = document.getElementById('resName').value || '-';
            const wa = document.getElementById('resWA').value || '-';
            const dev = document.getElementById('resDevice').value || '-';
            const model = document.getElementById('resModel').value || '-';
            const issue = document.getElementById('resIssue').value || '-';
            const servicesRaw = document.getElementById('resServices').value;

            document.getElementById('prevId').innerText = id;
            document.getElementById('prevDate').innerText = date;
            document.getElementById('prevName').innerText = name;
            document.getElementById('prevWA').innerText = wa;
            document.getElementById('prevDevice').innerText = dev;
            document.getElementById('prevModel').innerText = model;
            document.getElementById('prevIssue').innerText = issue;

            const container = document.getElementById('prevServices');
            container.innerHTML = '';
            let total = 0;
            
            if (servicesRaw.trim() !== '') {
                const lines = servicesRaw.split('\n');
                lines.forEach(line => {
                    if(line.trim() !== '') {
                        const parts = line.split('-');
                        let serviceName = line;
                        let price = 0;
                        let priceStr = '';

                        if (parts.length >= 2) {
                            serviceName = parts.slice(0, -1).join('-').trim();
                            const priceVal = parts[parts.length - 1].replace(/\D/g, '');
                            price = parseInt(priceVal) || 0;
                            priceStr = `Rp ${price.toLocaleString('id-ID')}`;
                        }

                        total += price;

                        const div = document.createElement('div');
                        div.className = 'receipt-row';
                        div.innerHTML = `<span>${serviceName}</span><span>${priceStr}</span>`;
                        container.appendChild(div);
                    }
                });
            } else {
                container.innerHTML = '<div style="font-size:0.8rem; text-align:center;">Belum ada data</div>';
            }

            document.getElementById('prevTotal').innerText = `Rp ${total.toLocaleString('id-ID')}`;
        }

        function printReceipt() {
            const id = document.getElementById('resOrderId').value;
            if(!id) { showToast('Nomor Order wajib diisi!'); return; }
            window.print();
        }

        // --- UPDATE: DOWNLOAD LANGSUNG (ONE CLICK) ---
        function downloadReceiptImage() {
            const id = document.getElementById('resOrderId').value;
            const btn = document.getElementById('btnDownload');
            
            if(!id) { showToast('Nomor Order wajib diisi!'); return; }

            const element = document.getElementById("receiptPreview");

            // Set loading state
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';

            html2canvas(element, { scale: 2 }).then(canvas => {
                // Metode Baru: Menggunakan toBlob (Binary) agar lebih kompatibel dengan Download Manager Android
                canvas.toBlob(function(blob) {
                    // Buat URL sementara dari Blob
                    const url = window.URL.createObjectURL(blob);
                    
                    // Buat elemen link download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `Resi-${id}.png`; // Nama file
                    
                    // Tambahkan ke body, klik, lalu hapus
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Bersihkan memory
                    window.URL.revokeObjectURL(url);

                    // Feedback & Reset Tombol
                    showToast("Download dimulai...", true);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 'image/png');

            }).catch(err => {
                console.error(err);
                showToast("Gagal membuat gambar.");
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        function openWhatsApp(number, message) {
            const encoded = encodeURIComponent(message);
            // Pastikan menggunakan https://wa.me
            const url = `https://wa.me/${number}?text=${encoded}`;
            
            // Gunakan window.location.href agar WebViewClient di Kotlin bisa menangkapnya dengan mudah
            window.location.href = url;
        }

        document.getElementById('darkModeBtn').addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });

        // Init
        updateLivePreview();
    </script>
</body>
</html>

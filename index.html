<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Malik Service Center Semarang. Servis HP, Laptop, iPhone, Tablet. Booking & Cek Status Online.">
    <meta name="theme-color" content="#2563eb">
    <title>Malik Service Center</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --light-bg: #f8fafc;
            --light-card: #ffffff;
            --text-main: #334155;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --transition: all 0.3s ease;
            --nav-height: 70px;
        }

        body.dark-mode {
            --light-bg: #0f172a;
            --light-card: #1e293b;
            --text-main: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--light-bg);
            color: var(--text-main);
            transition: var(--transition);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: calc(var(--nav-height) + 20px);
        }

        /* HEADER */
        header {
            background: var(--light-card);
            padding: 1rem 5%;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .header-actions button {
            background: none; border: none; font-size: 1.2rem; color: var(--text-main); cursor: pointer; margin-left: 10px;
        }

        /* MAIN CONTAINER */
        main { max-width: 800px; margin: 0 auto; padding: 1.5rem; width: 100%; flex: 1; }

        /* SECTIONS */
        .step-section {
            background: var(--light-card);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: none;
            animation: fadeIn 0.4s ease;
            margin-bottom: 1rem;
        }
        .step-section.active { display: block; }
        
        .full-width-section {
            background: transparent; box-shadow: none; padding: 0; display: none;
        }
        .full-width-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-bottom: 1rem; color: var(--primary); font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
        h3 { margin-bottom: 0.8rem; font-size: 1.1rem; color: var(--text-main); }
        p.subtitle { color: var(--text-light); margin-bottom: 1.5rem; font-size: 0.9rem; }

        /* FORMS */
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: var(--text-main); }
        input[type="text"], input[type="password"], input[type="tel"], input[type="date"], input[type="number"], select, textarea {
            width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--light-bg); color: var(--text-main); font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        input[readonly] { background-color: #e2e8f0; color: #64748b; cursor: default; border-color: transparent; }

        /* BUTTONS */
        .btn { 
            width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; 
            transition: var(--transition); display: flex; justify-content: center; align-items: center; gap: 8px; 
            font-size: 1rem; margin-bottom: 10px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-whatsapp:hover { background: #1ebc57; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-add { background: var(--secondary); color: white; margin-top: 5px;}
        .btn-sync { background: var(--accent); color: white; }
        .btn-sync:hover { background: #d97706; }
        
        .nav-buttons { display: flex; gap: 10px; margin-top: 1.5rem; }

        /* STATUS BADGES */
        .status-badge {
            padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;
        }
        .status-proses { background: #e0f2fe; color: #0284c7; }
        .status-kerja { background: #fef3c7; color: #d97706; }
        .status-selesai { background: #dcfce7; color: #16a34a; }

        /* ADMIN DASHBOARD STYLES */
        .admin-controls {
            display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;
        }
        .order-card {
            background: var(--light-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        .order-card.active-order {
            border-left: 4px solid var(--primary);
        }
        .order-header {
            display: flex; justify-content: space-between; margin-bottom: 10px;
        }
        .order-id { font-weight: bold; color: var(--primary); }
        .order-detail-row {
            display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px;
        }
        .order-label { color: var(--text-light); }
        .order-action-area {
            margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border);
        }
        .status-select {
            width: 100%; padding: 10px; margin-bottom: 10px;
        }

        /* HERO SPECIFIC */
        .hero-section { text-align: center; padding: 2rem 1rem; }
        .hero-icon { font-size: 3.5rem; color: var(--primary); margin-bottom: 1.5rem; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        
        /* SERVICE GRID */
        .service-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .service-card { 
            background: var(--light-bg); border: 1px solid var(--border); padding: 15px; 
            border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .service-card:hover { border-color: var(--primary); background: #eff6ff; transform: translateY(-2px); }
        .service-card i { font-size: 1.8rem; color: var(--primary); margin-bottom: 10px; display: block; }
        .service-card span { font-size: 0.85rem; font-weight: 600; }

        /* CART ITEM STYLE */
        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--light-bg); padding: 10px; border-radius: 8px; margin-bottom: 8px;
            border-left: 4px solid var(--secondary);
        }
        .cart-info h4 { font-size: 0.9rem; margin:0; color: var(--text-main); }
        .cart-info p { font-size: 0.8rem; margin:0; color: var(--text-light); }
        .btn-delete-item { 
            background: #fee2e2; color: #ef4444; border: none; border-radius: 50%; width: 30px; height: 30px; 
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .btn-delete-item:hover { background: #ef4444; color: white; }

        /* PICKUP BOX */
        .pickup-box {
            background-color: #e0f2fe;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            margin-bottom: 15px;
            display: none;
        }
        body.dark-mode .pickup-box {
            background-color: #1e3a8a;
            border-left-color: #60a5fa;
        }
        
        /* ARTICLE STYLES */
        .article-card {
            background: var(--light-card); border: 1px solid var(--border); border-radius: var(--radius);
            padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: 0.2s; display: flex; gap: 1rem;
        }
        .article-card:hover { border-color: var(--primary); box-shadow: var(--shadow); }
        .article-thumb { width: 80px; height: 80px; background: #e2e8f0; border-radius: 8px; flex-shrink: 0; object-fit: cover; }
        .article-info h4 { font-size: 1rem; margin-bottom: 5px; color: var(--text-main); }
        .article-info p { font-size: 0.8rem; color: var(--text-light); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .article-tag { display: inline-block; font-size: 0.7rem; background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; margin-bottom: 5px; }

        /* PRICE SUMMARY */
        .price-summary {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .price-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .price-total { border-top: 1px solid rgba(255,255,255,0.3); margin-top: 8px; padding-top: 8px; font-weight: bold; font-size: 1.1rem; display: flex; justify-content: space-between; }

        /* TOAST */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 12px 24px; border-radius: 50px; z-index: 2000; display: none; animation: slideDown 0.3s; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; font-size: 0.9rem; }
        .toast.success { background: var(--secondary); }
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* MODAL / ALERT CUSTOM */
        .custom-alert {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000;
            display: none; align-items: center; justify-content: center;
        }
        .alert-box {
            background: var(--light-card); padding: 20px; border-radius: var(--radius);
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: popIn 0.3s;
        }
        @keyframes popIn { from{transform: scale(0.8); opacity: 0;} to{transform: scale(1); opacity: 1;} }
        .alert-buttons { display: flex; gap: 10px; margin-top: 15px; }

        /* BOTTOM NAVIGATION */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--light-card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 999; box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: var(--text-light); font-size: 0.75rem;
            width: 20%; height: 100%; transition: 0.2s; background: none; border: none; cursor: pointer;
        }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); }

        /* Responsive */
        @media(max-width: 480px) { 
            .service-grid { grid-template-columns: 1fr 1fr; }
            .admin-controls { flex-direction: column; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand"><i class="fa-solid fa-screwdriver-wrench"></i> Malik Service</div>
        <div class="header-actions">
            <button id="darkModeBtn"><i class="fa-solid fa-moon"></i></button>
        </div>
    </header>

    <div id="toast" class="toast"></div>

    <!-- CUSTOM ALERT MODAL -->
    <div id="customAlert" class="custom-alert">
        <div class="alert-box">
            <h3 id="alertTitle" style="margin-bottom:10px;">Konfirmasi</h3>
            <p id="alertMessage" style="color:var(--text-light); margin-bottom:15px;">Apakah anda yakin?</p>
            <div class="alert-buttons" id="alertButtons">
                <!-- Buttons injected via JS -->
            </div>
        </div>
    </div>

    <main>
        <!-- 1. HERO SECTION (HOME) -->
        <section id="home-section" class="step-section active hero-section">
            <i class="fa-solid fa-microchip hero-icon"></i>
            <h1>Malik Service Center</h1>
            <p class="subtitle">Solusi perbaikan HP, Laptop & Elektronik Cepat & Bergaransi.</p>
            
            <div class="service-grid">
                <div class="service-card" onclick="selectQuickService('HP Android', 'LCD retak')">
                    <i class="fa-solid fa-mobile-screen"></i>
                    <span>Ganti LCD</span>
                </div>
                <div class="service-card" onclick="selectQuickService('HP Android', 'Baterai drop / kembung')">
                    <i class="fa-solid fa-battery-full"></i>
                    <span>Baterai Baru</span>
                </div>
                <div class="service-card" onclick="selectQuickService('Laptop', 'LCD pecah')">
                    <i class="fa-solid fa-laptop"></i>
                    <span>Servis Laptop</span>
                </div>
                <div class="service-card" onclick="selectQuickService('HP Android', 'Water damage ringan / berat')">
                    <i class="fa-solid fa-droplet"></i>
                    <span>Air Masuk</span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="navTo('order-section')">
                Buat Order Servis <i class="fa-solid fa-arrow-right"></i>
            </button>
            
            <button class="btn btn-outline" onclick="navTo('article-section')">
                <i class="fa-solid fa-book-open"></i> Baca Tips & Artikel
            </button>

            <button class="btn btn-outline" onclick="navTo('login-section')" style="margin-top:10px;">
                <i class="fa-solid fa-lock"></i> Login Admin
            </button>
            
            <div style="margin-top: 2rem; font-size: 0.8rem; color: var(--text-light);">
                <i class="fa-solid fa-database"></i> Database Update: <span id="dbStatus">Checking...</span>
            </div>
        </section>

        <!-- 2. FORM ORDER -->
        <section id="order-section" class="step-section full-width-section">
            <h2><i class="fa-solid fa-wrench"></i> Form Order Servis</h2>
            
            <div class="form-group">
                <label>Kategori Perangkat</label>
                <select id="custCategory" onchange="populateServiceDropdown()">
                    <option value="">-- Pilih Kategori --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Pilih Kerusakan & Tambahan</label>
                <select id="custService">
                    <option value="">-- Pilih Kerusakan & Harga --</option>
                </select>
                <small style="color:var(--text-light); font-size:0.8rem; margin-top:5px; display:block;">
                    *Klik tombol "Tambah" untuk memasukkan ke daftar kerusakan.
                </small>
                <button class="btn btn-add" onclick="addToCart()">
                    <i class="fa-solid fa-plus"></i> Tambah ke Daftar
                </button>
            </div>

            <!-- LIST ITEM DIPILIH (CART) -->
            <div id="cartListContainer" style="display:none; margin-bottom: 20px;">
                <h3 style="border-bottom: 1px solid var(--border); padding-bottom: 10px;">Daftar Perbaikan:</h3>
                <div id="cartItems">
                    <!-- Item muncul di sini via JS -->
                </div>
            </div>

            <!-- PICKUP -->
            <div class="form-group">
                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="needPickup" style="width:auto;" onchange="togglePickupInput()">
                    Butuh Jemput Unit (Pickup)?
                </label>
            </div>

            <div id="pickupInputGroup" class="pickup-box">
                <label>Jarak Lokasi (km)</label>
                <input type="number" id="pickupDistance" placeholder="Contoh: 3" oninput="renderCart()">
                <small id="pickupFeeText" style="display:block; margin-top:5px; color:var(--primary); font-weight:600;">
                    Biaya Pickup: Rp 0
                </small>
                <small style="display:block; margin-top:2px; font-size:0.75rem;">
                    *Biaya Rp 25.000 untuk jarak < 5km. > 5km hubungi admin.
                </small>
            </div>

            <!-- PRICE DISPLAY -->
            <div id="priceDisplay" class="price-summary">
                <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:5px;">Rincian Biaya:</div>
                <div class="price-row">
                    <span>Total Servis:</span>
                    <span id="dispTotalService">Rp 0</span>
                </div>
                <div class="price-row" id="pickupRow" style="display:none; color:#fef08a;">
                    <span>Pickup:</span>
                    <span id="dispPickup">Rp 0</span>
                </div>
                <div class="price-total">
                    <span>GRAND TOTAL:</span>
                    <span id="dispGrandTotal">Rp 0</span>
                </div>
                <div style="font-size:0.75rem; margin-top:8px; font-style:italic; opacity:0.9;">*Harga estimasi & bisa berubah setelah pengecekan.</div>
            </div>

            <div style="margin: 20px 0; border-top: 1px solid var(--border);"></div>
            
            <h3>Data Diri</h3>
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" id="custName" placeholder="Contoh: Budi Santoso">
            </div>
            <div class="form-group">
                <label>Nomor WhatsApp</label>
                <input type="tel" id="custWA" placeholder="0812...">
            </div>
            <div class="form-group">
                <label>Alamat / Detail Lokasi</label>
                <textarea id="custAddress" rows="2" placeholder="Alamat lengkap..."></textarea>
            </div>

            <button id="btnSendWA" class="btn btn-whatsapp" onclick="sendCustomerOrder()">
                <i class="fa-brands fa-whatsapp"></i> Kirim Order ke WA
            </button>
        </section>

        <!-- 3. LOGIN SECTION -->
        <section id="login-section" class="step-section">
            <h2><i class="fa-solid fa-user-shield"></i> Login Admin</h2>
            <p class="subtitle">Masuk untuk mengelola orderan.</p>
            
            <div class="form-group">
                <label>PIN Admin (6 Digit)</label>
                <input type="password" id="adminPin" placeholder="Masukkan PIN" maxlength="6" pattern="\d*">
                <small id="loginStatus" style="display:block; margin-top:5px; font-size:0.8rem;"></small>
            </div>
            <button id="btnLogin" class="btn btn-primary" onclick="handleLogin()">
                <span>Masuk Panel</span>
            </button>
            <button class="btn btn-secondary" onclick="navTo('home-section')">Kembali</button>
        </section>

        <!-- 4. RESI SECTION -->
        <section id="resi-section" class="step-section">
            <h2><i class="fa-solid fa-search"></i> Cek Status Pesanan</h2>
            <p class="subtitle">Masukkan Nomor Order (Resi) yang tertera di struk.</p>
            
            <div class="form-group">
                <label>Nomor Order</label>
                <input type="text" id="checkResiInput" placeholder="Contoh: INV-20231025-1234">
            </div>
            <button id="btnCheckResi" class="btn btn-primary" onclick="checkResi()">
                <i class="fa-solid fa-magnifying-glass"></i> Cek Status
            </button>

            <div id="resiResultBox" style="display:none; margin-top:20px;"></div>
        </section>

        <!-- 5. ADMIN PANEL (UPDATED) -->
        <section id="admin-panel" class="step-section full-width-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h2 style="margin:0;"><i class="fa-solid fa-layer-group"></i> Dashboard Order</h2>
                <button class="btn btn-danger" onclick="logout()" style="width:auto; padding: 8px 15px; font-size: 0.8rem; margin:0;">Keluar</button>
            </div>

            <div class="admin-controls">
                <button class="btn btn-sync" onclick="fetchOrdersFromSheet()">
                    <i class="fa-solid fa-rotate"></i> Sinkron Data Spreadsheet
                </button>
                <div style="flex:1;">
                    <input type="text" id="searchOrderAdmin" placeholder="Cari Nama / Order ID..." oninput="renderAdminOrders()">
                </div>
            </div>

            <div id="ordersContainer">
                <!-- Daftar Order akan muncul di sini -->
                <div style="text-align:center; padding: 40px; color: var(--text-light);">
                    <i class="fa-solid fa-cloud-arrow-down" style="font-size: 2rem; margin-bottom: 10px; display:block;"></i>
                    Belum ada data. Klik "Sinkron Data" untuk mengambil orderan terbaru.
                </div>
            </div>
        </section>

        <!-- 6. HALAMAN ARTIKEL -->
        <section id="article-section" class="step-section full-width-section">
            <h2><i class="fa-solid fa-newspaper"></i> Artikel & Tips</h2>
            <div id="articleList"></div>
            
            <!-- Detail View (Hidden by default) -->
            <div id="articleDetail" style="display:none;">
                <button class="btn btn-outline" onclick="closeArticleDetail()" style="margin-bottom:1rem;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
                <h1 id="detailTitle" style="color:var(--primary); font-size:1.5rem; margin-bottom:0.5rem;"></h1>
                <span id="detailTag" class="article-tag"></span>
                <div id="detailContent" style="margin-top:1rem; font-size:1rem; color:var(--text-main);"></div>
                <button class="btn btn-whatsapp" style="margin-top:2rem;" onclick="window.location.href='https://wa.me/6285713087659'">
                    Konsultasi Masalah Ini
                </button>
            </div>
        </section>

    </main>

    <!-- FLOATING WA -->
    <a href="https://wa.me/6285713087659" class="fab-wa" target="_blank" style="position:fixed; bottom:85px; right:20px; width:55px; height:55px; background:#25D366; border-radius:50%; display:flex; justify-content:center; align-items:center; color:white; font-size:24px; box-shadow:0 4px 10px rgba(0,0,0,0.2); z-index:998; text-decoration:none;">
        <i class="fa-brands fa-whatsapp"></i>
    </a>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navTo('home-section', this)">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="navTo('order-section', this)">
            <i class="fa-solid fa-cart-plus"></i>
            <span>Order</span>
        </button>
        <button class="nav-item" onclick="navTo('article-section', this)">
            <i class="fa-solid fa-book-open"></i>
            <span>Artikel</span>
        </button>
        <button class="nav-item" onclick="navTo('resi-section', this)">
            <i class="fa-solid fa-receipt"></i>
            <span>Cek Resi</span>
        </button>
        <button class="nav-item" onclick="navTo('login-section', this)">
            <i class="fa-solid fa-user-lock"></i>
            <span>Admin</span>
        </button>
    </nav>

    <!-- JAVASCRIPT -->
    <script>
        // ==========================================
        // 1. KONFIGURASI & KEAMANAN
        // ==========================================
        const CONFIG = {
            APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbwME7oupA7nWioXJh_lMTNnzaW3BNfD7Efnv8CzcfnlqvtFWUYgEwkscArhP_ZwTy0r/exec", 
            SESSION_TIMEOUT: 30 * 60 * 1000,
            ADMIN_WA: "6285713087659" // Nomor WA Admin
        };

        // Custom Alert Helper
        function showCustomAlert(title, message, buttons) {
            const modal = document.getElementById('customAlert');
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerHTML = message;
            
            const btnContainer = document.getElementById('alertButtons');
            btnContainer.innerHTML = '';
            
            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.className = `btn ${btn.class || 'btn-secondary'}`;
                b.style.margin = '0';
                b.innerText = btn.text;
                b.onclick = () => {
                    modal.style.display = 'none';
                    if(btn.onClick) btn.onClick();
                };
                btnContainer.appendChild(b);
            });
            
            modal.style.display = 'flex';
        }

        // ==========================================
        // 2. DATABASE LAYANAN (LOCAL)
        // ==========================================
        const masterServiceDatabase = [
            // ... (Sama seperti sebelumnya, saya ringkas agar tidak kepanjangan)
            // HP Android - LCD
            { cat: "HP Android", issue: "LCD retak", item: "LCD ORI", price: 550000, est: "3 Jam" },
            { cat: "HP Android", issue: "LCD retak", item: "LCD ORI (Layar Besar)", price: 750000, est: "3 Jam" },
            { cat: "HP Android", issue: "Baterai drop / kembung", item: "Baterai ORI", price: 330000, est: "1 Jam" },
            { cat: "HP Android", issue: "Konektor cas rusak", item: "Port Charging ORI", price: 200000, est: "1.5 Jam" },
            { cat: "HP Android", issue: "Speaker mati", item: "Speaker ORI", price: 180000, est: "1 Jam" },
            { cat: "HP Android", issue: "Water damage ringan / berat", item: "Cleaning Service", price: 200000, est: "1 Hari" },
            // LAPTOP
            { cat: "Laptop", issue: "LCD pecah", item: "LCD ORI (14 inch HD)", price: 1000000, est: "1 Hari" },
            { cat: "Laptop", issue: "Keyboard rusak", item: "Keyboard ORI (Standard)", price: 450000, est: "3 Jam" },
            { cat: "Laptop", issue: "Baterai laptop drop", item: "Baterai ORI (3 cell)", price: 500000, est: "1 Jam" },
            { cat: "Laptop", issue: "Laptop lemot", item: "Upgrade SSD (256GB SATA)", price: 450000, est: "1.5 Jam" },
            { cat: "Laptop", issue: "Install ulang Windows", item: "Windows OS (Original)", price: 150000, est: "2 Jam" }
        ];

        const DB = {
            init: () => {
                const localData = localStorage.getItem('malik_services_v4');
                let data = [];
                if (localData) data = JSON.parse(localData);
                else { data = masterServiceDatabase; localStorage.setItem('malik_services_v4', JSON.stringify(data)); }
                return data;
            },
            getCategories: (data) => { const cats = new Set(data.map(i => i.cat)); return Array.from(cats).sort(); },
            logUpdate: () => { const now = new Date(); document.getElementById('dbStatus').innerText = now.toLocaleDateString('id-ID') + ' ' + now.toLocaleTimeString('id-ID'); }
        };

        const serviceData = DB.init();
        DB.logUpdate();

        // ==========================================
        // 3. STATE MANAGEMENT (CART & ADMIN)
        // ==========================================
        let cart = []; 
        let adminOrders = []; // Menyimpan data order yang diambil dari sheet

        function addToCart() {
            const select = document.getElementById('custService');
            const val = select.value;
            if(!val) { showToast("Pilih kerusakan dulu!"); return; }
            const item = JSON.parse(val);
            cart.push(item);
            renderCart();
            select.value = "";
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const listContainer = document.getElementById('cartListContainer');
            const priceBox = document.getElementById('priceDisplay');
            
            if(cart.length === 0) {
                container.innerHTML = ''; listContainer.style.display = 'none'; priceBox.style.display = 'none'; return;
            }
            listContainer.style.display = 'block'; priceBox.style.display = 'block';

            container.innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <div class="cart-info"><h4>${item.issue} (${item.item})</h4><p>${formatRupiah(item.price)}</p></div>
                    <button class="btn-delete-item" onclick="removeFromCart(${index})"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');

            const totalService = cart.reduce((acc, curr) => acc + curr.price, 0);
            const pickupFee = calculatePickup();
            let finalTotal = totalService + (pickupFee === 25000 ? 25000 : 0);
            
            document.getElementById('dispTotalService').textContent = formatRupiah(totalService);
            const pickupRow = document.getElementById('pickupRow');
            if(document.getElementById('needPickup').checked) {
                pickupRow.style.display = 'flex';
                document.getElementById('dispPickup').textContent = pickupFee === 25000 ? "Rp 25.000" : "Hubungi Admin";
            } else { pickupRow.style.display = 'none'; }
            
            document.getElementById('dispGrandTotal').textContent = formatRupiah(finalTotal);
        }

        function calculatePickup() {
            if(!document.getElementById('needPickup').checked) return 0;
            const dist = parseFloat(document.getElementById('pickupDistance').value) || 0;
            if(dist > 0 && dist < 5) return 25000;
            return 0;
        }

        // ==========================================
        // 4. AUTHENTICATION
        // ==========================================
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function handleLogin() {
            const pinInput = document.getElementById('adminPin').value;
            const btn = document.getElementById('btnLogin');
            const statusTxt = document.getElementById('loginStatus');
            if(!pinInput) { showToast("PIN wajib diisi"); return; }

            const hashedPin = await sha256(pinInput);
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...';
            statusTxt.innerText = "Memvalidasi...";

            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "login", pinHash: hashedPin })
                });
                const result = await response.json();
                if (result.success) {
                    localStorage.setItem('malik_admin_session', JSON.stringify({ time: Date.now() }));
                    showToast("Login Berhasil!", true);
                    navTo('admin-panel');
                } else {
                    showToast(result.message);
                    statusTxt.innerText = result.message;
                }
            } catch (error) {
                console.error(error);
                showToast("Gagal koneksi ke Server.");
            }
            btn.disabled = false; btn.innerHTML = '<span>Masuk Panel</span>';
        }

        function checkSession() {
            const session = JSON.parse(localStorage.getItem('malik_admin_session'));
            return session && (Date.now() - session.time < CONFIG.SESSION_TIMEOUT);
        }

        function logout() {
            localStorage.removeItem('malik_admin_session');
            navTo('login-section');
        }

        // ==========================================
        // 5. ORDER FLOW & SHEET SYNC
        // ==========================================
        
        // 5A. Kirim Order dari Pelanggan
        async function sendCustomerOrder() {
            const name = document.getElementById('custName').value;
            const wa = document.getElementById('custWA').value;
            const address = document.getElementById('custAddress').value;

            if(!name || !wa) { showToast("Nama & WA wajib diisi"); return; }
            if(cart.length === 0) { showToast("Belum ada layanan yang dipilih"); return; }

            const newOrderId = generateOrderId(); 
            
            let msg = `Halo Admin, saya mau servis.\n\nNama: ${name}\nWA: ${wa}\nAlamat: ${address}\n\n--- Daftar Perbaikan ---\n`;
            let totalEst = 0;
            cart.forEach((item, idx) => {
                totalEst += item.price;
                msg += `${idx+1}. ${item.cat} - ${item.issue} (${formatRupiah(item.price)})\n`;
            });
            const pickup = calculatePickup();
            if(pickup === 25000) { totalEst += 25000; msg += `\nBiaya Pickup: +Rp 25.000`; }
            msg += `\n*TOTAL ESTIMASI: ${formatRupiah(totalEst)}*`;

            const payload = { 
                action: "save_order",
                orderId: newOrderId, name: name, wa: wa, address: address, 
                cat: cart.length > 1 ? 'Multiple' : cart[0].cat, 
                items: cart, total: totalEst 
            };

            // Kirim ke Sheet (Background)
            fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(data => console.log("Sheet Saved:", data))
                .catch(e => console.warn("Sheet Error:", e));

            // Buka WA
            window.open(`https://wa.me/${CONFIG.ADMIN_WA}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // 5B. Admin: Ambil Data dari Sheet
        async function fetchOrdersFromSheet() {
            const btn = document.querySelector('.btn-sync');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengambil Data...';

            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "get_all_orders" })
                });
                const result = await response.json();
                
                if(result.success) {
                    adminOrders = result.data; // Simpan ke global variable
                    renderAdminOrders();
                    showToast(`Berhasil mengambil ${adminOrders.length} order`, true);
                } else {
                    showToast("Gagal mengambil data: " + result.message);
                }
            } catch (error) {
                console.error(error);
                showToast("Terjadi kesalahan koneksi.");
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Sinkron Data Spreadsheet';
        }

        // 5C. Admin: Render Orders ke UI
        function renderAdminOrders() {
            const container = document.getElementById('ordersContainer');
            const search = document.getElementById('searchOrderAdmin').value.toLowerCase();
            
            if(!adminOrders || adminOrders.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-light)">Belum ada data. Klik tombol "Sinkron Data".</div>`;
                return;
            }

            const filtered = adminOrders.filter(o => 
                o.orderId.toLowerCase().includes(search) || 
                o.customerName.toLowerCase().includes(search)
            );

            if(filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:20px;">Data tidak ditemukan.</div>`;
                return;
            }

            container.innerHTML = filtered.map((order, index) => `
                <div class="order-card">
                    <div class="order-header">
                        <span class="order-id">#${order.orderId}</span>
                        <span class="status-badge status-${getSimpleStatus(order.status)}">${order.status}</span>
                    </div>
                    <div class="order-detail-row">
                        <span class="order-label">Nama:</span>
                        <span style="font-weight:600;">${order.customerName}</span>
                    </div>
                    <div class="order-detail-row">
                        <span class="order-label">Perangkat:</span>
                        <span>${order.category}</span>
                    </div>
                    <div class="order-detail-row">
                        <span class="order-label">Kerusakan:</span>
                        <span style="font-size:0.85rem;">${order.services}</span>
                    </div>
                    <div class="order-action-area">
                        <label style="font-size:0.8rem;">Update Status:</label>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-secondary" style="flex:1; padding:10px;" onclick="updateOrderStatus('${order.orderId}', 'Proses')">Proses</button>
                            <button class="btn btn-primary" style="flex:1; padding:10px; background:var(--accent);" onclick="updateOrderStatus('${order.orderId}', 'Sedang Dikerjakan')">Kerjakan</button>
                            <button class="btn btn-primary" style="flex:1; padding:10px;" onclick="promptFinishOrder('${order.orderId}', '${order.wa}', '${order.customerName}')">Selesai</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getSimpleStatus(status) {
            if(status.includes('Selesai')) return 'selesai';
            if(status.includes('Dikerjakan')) return 'kerja';
            return 'proses';
        }

        // 5D. Admin: Update Status
        async function updateOrderStatus(orderId, newStatus) {
            showToast(`Status diubah menjadi: ${newStatus}`, true);
            
            // Optimistic UI Update (Update tampilan langsung dulu biar cepat)
            const orderIdx = adminOrders.findIndex(o => o.orderId === orderId);
            if(orderIdx > -1) adminOrders[orderIdx].status = newStatus;
            renderAdminOrders();

            // Kirim ke Sheet (Async)
            fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "update_status",
                    orderId: orderId,
                    newStatus: newStatus
                })
            }).catch(e => console.warn("Gagal update status ke sheet", e));
        }

        // 5E. Admin: Logic Selesai & WA
        function promptFinishOrder(orderId, waNumber, custName) {
            // Bersihkan nomor WA (hapus 62/0 di depan jika perlu, asumsi format 628...)
            let cleanWA = waNumber.replace(/[^0-9]/g, '');
            if(cleanWA.startsWith('0')) cleanWA = '62' + cleanWA.substring(1);

            showCustomAlert(
                "Selesaikan Pesanan?", 
                `Device untuk <b>${custName}</b> sudah selesai diperbaiki?`,
                [
                    {
                        text: "Berhasil Diperbaiki",
                        class: "btn-whatsapp",
                        onClick: () => {
                            updateOrderStatus(orderId, "Selesai (Berhasil)");
                            const msg = `Halo ${custName}, kami informasikan bahwa perangkat Anda SUDAH BERHASIL diperbaiki dan siap diambil/dikirim. Terima kasih telah mempercayakan device Anda kepada Malik Service!`;
                            window.open(`https://wa.me/${cleanWA}?text=${encodeURIComponent(msg)}`, '_blank');
                        }
                    },
                    {
                        text: "Tidak Berhasil",
                        class: "btn-danger",
                        onClick: () => {
                            updateOrderStatus(orderId, "Selesai (Gagal)");
                            const msg = `Halo ${custName}, mohon maaf, setelah dilakukan pengecekan lebih lanjut, perangkat Anda mengalami kerusakan yang tidak bisa diperbaiki (atau biaya perbaikan setara dengan harga baru). Silakan hubungi admin untuk diskusi lebih lanjut mengenai opsi data recovery.`;
                            window.open(`https://wa.me/${cleanWA}?text=${encodeURIComponent(msg)}`, '_blank');
                        }
                    },
                    { text: "Batal", class: "btn-secondary" }
                ]
            );
        }

        // ==========================================
        // 6. UI HELPERS & NAVIGATION
        // ==========================================
        function navTo(sectionId, btnElement = null) {
            if(sectionId === 'admin-panel' && !checkSession()) { navTo('login-section'); return; }

            document.querySelectorAll('.step-section, .full-width-section').forEach(sec => {
                sec.classList.remove('active'); sec.style.display = 'none';
            });
            
            const target = document.getElementById(sectionId);
            if(target) {
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);
            }
            window.scrollTo(0,0);

            // Nav Highlighting
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            else {
                if(sectionId === 'home-section') document.querySelectorAll('.nav-item')[0].classList.add('active');
                if(sectionId === 'order-section') document.querySelectorAll('.nav-item')[1].classList.add('active');
                if(sectionId === 'article-section') document.querySelectorAll('.nav-item')[2].classList.add('active');
                if(sectionId === 'resi-section') document.querySelectorAll('.nav-item')[3].classList.add('active');
                if(sectionId === 'login-section' || sectionId === 'admin-panel') document.querySelectorAll('.nav-item')[4].classList.add('active');
            }

            if(sectionId === 'order-section') populateCategories();
            if(sectionId === 'article-section') renderArticleList();
        }

        function showToast(msg, isSuccess = false) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.className = `toast ${isSuccess ? 'success' : ''}`;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        document.getElementById('darkModeBtn').addEventListener('click', () => document.body.classList.toggle('dark-mode'));

        function formatRupiah(num) { return "Rp " + parseInt(num).toLocaleString('id-ID'); }
        function generateOrderId() { 
            const d = new Date(); 
            return `INV-${d.getFullYear()}${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}-${Math.floor(Math.random()*10000)}`; 
        }
        function selectQuickService(cat, issue) {
            navTo('order-section');
            setTimeout(() => {
                document.getElementById('custCategory').value = cat;
                populateServiceDropdown();
                const servSelect = document.getElementById('custService');
                for(let i=0; i<servSelect.options.length; i++){
                    if(servSelect.options[i].text.includes(issue)) { servSelect.selectedIndex = i; break; }
                }
                addToCart();
            }, 100);
        }
        function togglePickupInput() {
            document.getElementById('pickupInputGroup').style.display = document.getElementById('needPickup').checked ? 'block' : 'none';
            renderCart();
        }
        function populateCategories() {
            const select = document.getElementById('custCategory');
            if(select.options.length > 1) return;
            DB.getCategories(serviceData).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.textContent = cat; select.appendChild(opt);
            });
        }
        function populateServiceDropdown() {
            const cat = document.getElementById('custCategory').value;
            const servSelect = document.getElementById('custService');
            servSelect.innerHTML = '<option value="">-- Pilih Kerusakan & Harga --</option>';
            if(!cat) return;
            serviceData.filter(s => s.cat === cat).forEach(item => {
                const opt = document.createElement('option');
                opt.value = JSON.stringify(item);
                opt.textContent = `${item.issue} (${item.item}) - ${formatRupiah(item.price)}`;
                servSelect.appendChild(opt);
            });
        }

        // ==========================================
        // 7. RESI CHECK & ARTICLE
        // ==========================================
        async function checkResi() {
            const inputId = document.getElementById('checkResiInput').value.trim();
            const resultBox = document.getElementById('resiResultBox');
            const btn = document.getElementById('btnCheckResi');

            if(!inputId) { showToast("Masukkan Nomor Order!"); return; }

            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mencari...';

            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "check_resi", resiId: inputId })
                });
                const result = await response.json();

                if (result.success) {
                    const d = result.data;
                    resultBox.style.display = 'block';
                    resultBox.innerHTML = `
                        <div style="background:#eff6ff; padding:15px; border-radius:8px; border-left:4px solid var(--primary);">
                            <h4 style="margin:0 0 10px 0; color:var(--primary);">Status Pesanan: ${d.status}</h4>
                            <p><strong>Nama:</strong> ${d.customerName}</p>
                            <p><strong>Layanan:</strong> ${d.services}</p>
                            <p><strong>Total:</strong> ${formatRupiah(d.total)}</p>
                        </div>`;
                } else {
                    resultBox.style.display = 'block';
                    resultBox.innerHTML = `<div style="background:#fee2e2; color:#b91c1c; padding:15px; border-radius:8px; text-align:center;">Order ID Tidak Ditemukan</div>`;
                }
            } catch (error) {
                resultBox.style.display = 'block';
                resultBox.innerHTML = `<div style="background:#fff7ed; color:#c2410c; padding:15px; border-radius:8px; text-align:center;">Gagal menghubungi server.</div>`;
            }
            btn.disabled = false; btn.innerHTML = 'Cek Status';
        }

        const articles = [
            { title: "HP Tidak Bisa Di-charge?", tag: "Tips HP", content: "Ini penyebab umumnya: 1. Kabel rusak. 2. Port kotor. 3. Baterai drop." },
            { title: "LCD Retak Masih Bisa Dipakai?", tag: "Kerusakan Umum", content: "Bisa, tapi berisiko. Cairan LCD bisa merembes." },
            { title: "Water Damage, Apa Harus Dinyalakan?", tag: "Tips HP", content: "TIDAK. Matikan total, jangan cas. Segera bawa ke teknisi." }
        ];
        function renderArticleList() {
            const container = document.getElementById('articleList');
            if(container.children.length > 0) return;
            articles.forEach((art, index) => {
                const div = document.createElement('div');
                div.className = 'article-card';
                div.onclick = () => openArticle(index);
                div.innerHTML = `<img src="https://picsum.photos/seed/${index}/80/80" class="article-thumb" alt="icon">
                    <div class="article-info"><span class="article-tag">${art.tag}</span><h4>${art.title}</h4><p>${art.content}</p></div>`;
                container.appendChild(div);
            });
        }
        function openArticle(index) {
            const art = articles[index];
            document.getElementById('articleList').style.display = 'none';
            const detail = document.getElementById('articleDetail');
            detail.style.display = 'block';
            document.getElementById('detailTitle').innerText = art.title;
            document.getElementById('detailTag').innerText = art.tag;
            document.getElementById('detailContent').innerHTML = `<p>${art.content}</p>`;
        }
        function closeArticleDetail() {
            document.getElementById('articleDetail').style.display = 'none';
            document.getElementById('articleList').style.display = 'block';
        }
    </script>
</body>
</html>


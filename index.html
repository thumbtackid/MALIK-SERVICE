<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Malik Service - Aplikasi Servis Terpadu</title>
  <style>
    /* --- CSS VARIABLES & RESET --- */
    :root {
      --primary: #0056b3; /* Biru Profesional */
      --secondary: #28a745; /* Hijau Aksi */
      --dark: #343a40;
      --light: #f8f9fa;
      --danger: #dc3545;
      --warning: #ffc107;
      --gray: #6c757d;
      --shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f4f6f9; color: var(--dark); line-height: 1.6; }
    
    /* --- UTILITIES --- */
    .hidden { display: none !important; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #004494; }
    .btn-secondary { background: var(--secondary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card { background: white; border-radius: 8px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,86,179,0.1); }
    
    /* --- AUTH PAGES --- */
    .auth-wrapper { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--primary), var(--dark)); }
    .auth-box { width: 100%; max-width: 400px; }
    .auth-title { text-align: center; margin-bottom: 20px; color: var(--primary); }
    .auth-footer { text-align: center; margin-top: 15px; font-size: 14px; }
    .auth-footer a { color: var(--primary); text-decoration: none; cursor: pointer; }
    
    /* --- DASHBOARD LAYOUT --- */
    .app-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 250px; background: var(--dark); color: white; flex-shrink: 0; transition: 0.3s; display: flex; flex-direction: column; }
    .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-menu { flex: 1; padding: 20px 0; overflow-y: auto; }
    .menu-item { display: block; padding: 12px 20px; color: #ccc; text-decoration: none; border-left: 4px solid transparent; cursor: pointer; }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; border-left-color: var(--secondary); }
    .menu-category { padding: 10px 20px; font-size: 12px; text-transform: uppercase; color: var(--gray); margin-top: 10px; font-weight: bold; }
    
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .topbar { background: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .content-scroll { flex: 1; overflow-y: auto; padding: 20px; }
    
    /* --- DASHBOARD WIDGETS --- */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: var(--shadow); border-left: 4px solid var(--primary); }
    .stat-value { font-size: 24px; font-weight: bold; margin: 5px 0; }
    .stat-label { color: var(--gray); font-size: 14px; }
    
    /* --- TABLES --- */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; color: var(--dark); }
    .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .badge-pending { background: #ffeeba; color: #856404; }
    .badge-proses { background: #b8daff; color: #004085; }
    .badge-selesai { background: #c3e6cb; color: #155724; }
    .badge-batal { background: #f5c6cb; color: #721c24; }
    
    /* --- TOAST NOTIFICATIONS --- */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .toast { background: white; padding: 15px 20px; border-radius: 4px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; border-left: 4px solid var(--primary); animation: slideIn 0.3s ease; }
    .toast.error { border-left-color: var(--danger); }
    .toast.success { border-left-color: var(--secondary); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    
    /* --- FOOTER --- */
    footer { text-align: center; padding: 20px; color: var(--gray); font-size: 12px; border-top: 1px solid #ddd; margin-top: auto; }
    
    /* --- MOBILE RESPONSIVE --- */
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -250px; height: 100%; z-index: 1000; }
      .sidebar.active { left: 0; }
      .menu-toggle { display: block; cursor: pointer; font-size: 24px; }
    }
    @media (min-width: 769px) {
      .menu-toggle { display: none; }
    }
    
    /* Loading Overlay */
    .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- NOTIFICATIONS -->
  <div id="toast-container" class="toast-container"></div>
  <div id="loader" class="loader-overlay hidden"><div class="spinner"></div></div>

  <!-- 1. AUTH VIEW (LOGIN) -->
  <section id="view-login" class="auth-wrapper">
    <div class="card auth-box">
      <h2 class="auth-title">Malik Service Login</h2>
      <form id="form-login">
        <div class="form-group">
          <label>Email / No HP</label>
          <input type="text" id="login-id" class="form-control" placeholder="Masukkan email atau no hp" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" class="form-control" placeholder="Masukkan password" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%">MASUK</button>
      </form>
      <div class="auth-footer">
        Belum punya akun? <a onclick="App.navTo('register')">Daftar disini</a>
      </div>
    </div>
  </section>

  <!-- 2. AUTH VIEW (REGISTER) -->
  <section id="view-register" class="auth-wrapper hidden">
    <div class="card auth-box">
      <h2 class="auth-title">Daftar Akun Baru</h2>
      <form id="form-register">
        <div class="form-group">
          <label>Nama Lengkap</label>
          <input type="text" id="reg-nama" class="form-control" required>
        </div>
        <div class="form-group">
          <label>No HP / WhatsApp</label>
          <input type="tel" id="reg-nohp" class="form-control" placeholder="08xxxx" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="reg-email" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="reg-password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-secondary" style="width: 100%">DAFTAR</button>
      </form>
      <div class="auth-footer">
        Sudah punya akun? <a onclick="App.navTo('login')">Login disini</a>
      </div>
    </div>
  </section>

  <!-- 3. MAIN APP LAYOUT (ADMIN & USER) -->
  <section id="view-app" class="app-layout hidden">
    
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h3>MALIK SERVICE</h3>
        <small>Servis HP & Laptop</small>
      </div>
      <div class="sidebar-menu" id="sidebar-menu-content">
        <!-- Menu injected by JS based on Role -->
      </div>
    </aside>

    <!-- CONTENT -->
    <main class="main-content">
      <div class="topbar">
        <div class="menu-toggle" onclick="toggleSidebar()">â˜°</div>
        <h3 id="page-title">Dashboard</h3>
        <div class="user-info">
          <span id="user-display-name">User</span>
          <button class="btn btn-sm btn-danger" onclick="App.logout()">Logout</button>
        </div>
      </div>
      
      <div class="content-scroll" id="main-content-area">
        <!-- Dynamic Content Loaded Here -->
      </div>

      <footer>
        <p>&copy; 2023 Malik Service. Alamat: Jamalsari Mijen, Jl. Untung Suropati, Kota Semarang. WA: 085713087659</p>
      </footer>
    </main>
  </section>

  <script>
    // --- APPLICATION LOGIC ---
    const App = {
      data: {
        user: null // { id, nama, role, email }
      },

      init: function() {
        // Cek LocalStorage
        const savedUser = localStorage.getItem('malikUser');
        if (savedUser) {
          this.data.user = JSON.parse(savedUser);
          this.loadApp();
        } else {
          this.navTo('login');
        }
        
        // Setup Event Listeners
        this.setupListeners();
      },

      setupListeners: function() {
        document.getElementById('form-login').addEventListener('submit', this.handleLogin);
        document.getElementById('form-register').addEventListener('submit', this.handleRegister);
      },

      navTo: function(viewId) {
        // Hide all sections
        document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
        
        if (viewId === 'login') {
          document.getElementById('view-login').classList.remove('hidden');
        } else if (viewId === 'register') {
          document.getElementById('view-register').classList.remove('hidden');
        } else if (viewId === 'app') {
          document.getElementById('view-app').classList.remove('hidden');
        }
      },

      handleLogin: function(e) {
        e.preventDefault();
        const id = document.getElementById('login-id').value;
        const pass = document.getElementById('login-password').value;
        
        App.showLoader(true);
        google.script.run
          .withSuccessHandler(function(res) {
            App.showLoader(false);
            if (res.status === 'success') {
              App.data.user = res.data;
              localStorage.setItem('malikUser', JSON.stringify(res.data));
              App.loadApp();
              App.toast('Login Berhasil!', 'success');
            } else {
              App.toast(res.message, 'error');
            }
          })
          .withFailureHandler(function(err) {
            App.showLoader(false);
            App.toast('Koneksi Error: ' + err.message, 'error');
          })
          .doLogin(id, pass);
      },

      handleRegister: function(e) {
        e.preventDefault();
        const data = {
          nama: document.getElementById('reg-nama').value,
          nohp: document.getElementById('reg-nohp').value,
          email: document.getElementById('reg-email').value,
          password: document.getElementById('reg-password').value
        };
        
        App.showLoader(true);
        google.script.run
          .withSuccessHandler(function(res) {
            App.showLoader(false);
            if (res.status === 'success') {
              App.toast(res.message, 'success');
              App.navTo('login');
            } else {
              App.toast(res.message, 'error');
            }
          })
          .doRegister(data);
      },

      logout: function() {
        if(confirm('Yakin ingin keluar?')) {
          this.data.user = null;
          localStorage.removeItem('malikUser');
          this.navTo('login');
          this.toast('Anda telah logout', 'success');
        }
      },

      loadApp: function() {
        this.navTo('app');
        document.getElementById('user-display-name').textContent = this.data.user.nama + ' (' + this.data.user.role + ')';
        this.renderSidebar();
        
        // Default load dashboard based on role
        if (this.data.user.role === 'ADMIN') {
          this.loadAdminDashboard();
        } else {
          this.loadUserDashboard();
        }
      },

      renderSidebar: function() {
        const menuContainer = document.getElementById('sidebar-menu-content');
        let html = '';
        
        if (this.data.user.role === 'ADMIN') {
          html += '<div class="menu-category">ADMIN MENU</div>';
          html += '<a class="menu-item" onclick="App.loadAdminDashboard()">Dashboard</a>';
          html += '<a class="menu-item" onclick="App.loadAdminOrders()">Manajemen Order</a>';
          html += '<a class="menu-item" onclick="App.loadMasterLayanan()">Master Layanan</a>';
          html += '<a class="menu-item" onclick="App.toast("Fitur Demo Keuangan")">Keuangan</a>';
        } else {
          html += '<div class="menu-category">USER MENU</div>';
          html += '<a class="menu-item" onclick="App.loadUserDashboard()">Dashboard & Status</a>';
          html += '<a class="menu-item" onclick="App.loadCreateOrder()">Buat Order Baru</a>';
          html += '<a class="menu-item" onclick="App.loadUserHistory()">Riwayat Servis</a>';
        }
        
        menuContainer.innerHTML = html;
      },

      // --- ADMIN FUNCTIONS ---
      
      loadAdminDashboard: function() {
        this.setPageTitle('Admin Dashboard');
        const content = document.getElementById('main-content-area');
        
        App.showLoader(true);
        google.script.run.withSuccessHandler(stats => {
          App.showLoader(false);
          content.innerHTML = `
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Order Hari Ini</div>
                <div class="stat-value">${stats.totalOrders}</div>
              </div>
              <div class="stat-card" style="border-color: #ffc107">
                <div class="stat-label">Pending</div>
                <div class="stat-value">${stats.pending}</div>
              </div>
              <div class="stat-card" style="border-color: #17a2b8">
                <div class="stat-label">Proses</div>
                <div class="stat-value">${stats.proses}</div>
              </div>
              <div class="stat-card" style="border-color: #28a745">
                <div class="stat-label">Omset Bulan Ini</div>
                <div class="stat-value">Rp ${stats.omsetBulanIni.toLocaleString()}</div>
              </div>
            </div>
            <div class="card">
              <h4>Order Terbaru</h4>
              <div id="recent-orders-table"></div>
            </div>
          `;
          // Load recent orders mini table
          App.loadOrdersTable('recent-orders-table', 5); 
        }).getDashboardStats('ADMIN');
      },

      loadAdminOrders: function() {
        this.setPageTitle('Semua Order Masuk');
        document.getElementById('main-content-area').innerHTML = '<div id="admin-orders-full" class="card"></div>';
        this.loadOrdersTable('admin-orders-full', 100);
      },

      loadOrdersTable: function(containerId, limit) {
        google.script.run.withSuccessHandler(orders => {
          const container = document.getElementById(containerId);
          if(orders.length === 0) {
            container.innerHTML = '<p class="text-center">Belum ada data order.</p>';
            return;
          }
          
          let html = `
            <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Pelanggan</th>
                  <th>Device / Layanan</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          orders.slice(0, limit).forEach(o => {
            let badgeClass = '';
            switch(o.status) {
              case 'PENDING': badgeClass = 'badge-pending'; break;
              case 'PROSES': badgeClass = 'badge-proses'; break;
              case 'SELESAI': badgeClass = 'badge-selesai'; break;
              default: badgeClass = 'badge-batal';
            }
            
            html += `
              <tr>
                <td>${o.id}</td>
                <td>${o.customer}<br><small>${o.phone}</small></td>
                <td>${o.device}<br><small>${o.serviceName}</small></td>
                <td><span class="badge ${badgeClass}">${o.status}</span></td>
                <td>
                  ${App.data.user.role === 'ADMIN' ? `
                    <select onchange="App.changeStatus('${o.id}', this.value)" style="padding:5px">
                      <option value="">Ubah Status...</option>
                      <option value="ACC">ACC</option>
                      <option value="PROSES">Proses</option>
                      <option value="SELESAI">Selesai</option>
                      <option value="BATAL">Batal</option>
                    </select>
                  ` : `<small>${o.status}</small>`}
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table></div>';
          container.innerHTML = html;
        }).getOrders(this.data.user.id, this.data.user.role);
      },

      changeStatus: function(orderId, newStatus) {
        if(!newStatus) return;
        App.showLoader(true);
        google.script.run.withSuccessHandler(res => {
          App.showLoader(false);
          App.toast('Order diperbarui', 'success');
          this.loadAdminOrders(); // Refresh
        }).updateOrderStatus(orderId, newStatus, this.data.user.id);
      },

      loadMasterLayanan: function() {
        this.setPageTitle('Master Layanan');
        const content = document.getElementById('main-content-area');
        content.innerHTML = `
          <div class="card">
            <button class="btn btn-primary" onclick="App.showAddLayananModal()">+ Tambah Layanan</button>
            <div id="layanan-list" style="margin-top:20px"></div>
          </div>
        `;
        this.refreshLayananList();
      },
      
      refreshLayananList: function() {
        google.script.run.withSuccessHandler(list => {
          let html = '<div class="table-responsive"><table><thead><tr><th>Layanan</th><th>Kategori</th><th>Harga</th><th>Aksi</th></tr></thead><tbody>';
          list.forEach(l => {
            html += `<tr>
              <td>${l.name}<br><small>${l.desc}</small></td>
              <td>${l.category}</td>
              <td>Rp ${parseInt(l.sellPrice).toLocaleString()}</td>
              <td><button class="btn btn-sm btn-danger" onclick="App.toast('Hapus belum aktif')">Hapus</button></td>
            </tr>`;
          });
          html += '</tbody></table></div>';
          document.getElementById('layanan-list').innerHTML = html;
        }).getMasterLayanan();
      },

      // --- USER FUNCTIONS ---

      loadUserDashboard: function() {
        this.setPageTitle('Dashboard Pelanggan');
        const content = document.getElementById('main-content-area');
        
        App.showLoader(true);
        google.script.run.withSuccessHandler(orders => {
          App.showLoader(false);
          // Filter active orders (not selesai/batal)
          const active = orders.filter(o => o.status !== 'SELESAI' && o.status !== 'BATAL');
          
          let html = '';
          if (active.length > 0) {
            html = `<div class="card" style="border-left: 5px solid var(--secondary)">
              <h4>ðŸ“± Status Order Anda</h4>
              ${active.map(o => `
                <div style="margin-top:10px; padding:10px; background:#f1f1f1; border-radius:5px">
                  <strong>${o.device}</strong> - ${o.serviceName}<br>
                  Status: <span class="badge badge-proses">${o.status}</span><br>
                  <small>ID: ${o.id}</small>
                </div>
              `).join('')}
            </div>`;
          } else {
            html = `<div class="card"><p>Tidak ada order aktif.</p><button class="btn btn-primary" onclick="App.loadCreateOrder()">Buat Order Sekarang</button></div>`;
          }
          
          content.innerHTML = html;
        }).getOrders(this.data.user.id, this.data.user.role);
      },

      loadCreateOrder: function() {
        this.setPageTitle('Buat Order Baru');
        const content = document.getElementById('main-content-area');
        content.innerHTML = `
          <div class="card" style="max-width: 600px; margin: 0 auto;">
            <form id="form-create-order">
              <div class="form-group">
                <label>Data Perangkat</label>
                <input type="text" id="co-device" class="form-control" placeholder="Contoh: Samsung A52" required>
              </div>
              <div class="form-group">
                <label>Keluhan</label>
                <textarea id="co-issue" class="form-control" rows="3" placeholder="Jelaskan kerusakan..." required></textarea>
              </div>
              <div class="form-group">
                <label>Pilih Layanan</label>
                <select id="co-service" class="form-control" onchange="App.updatePriceInfo(this)" required>
                  <option value="">-- Pilih Layanan --</option>
                </select>
              </div>
              <div class="form-group">
                <label>Estimasi Biaya</label>
                <input type="text" id="co-price-display" class="form-control" readonly value="Rp 0">
              </div>
              <button type="submit" class="btn btn-primary" style="width:100%">Kirim Order</button>
            </form>
          </div>
        `;
        
        // Populate Services
        google.script.run.withSuccessHandler(services => {
          const select = document.getElementById('co-service');
          services.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.text = `${s.name} - Rp ${parseInt(s.sellPrice).toLocaleString()}`;
            opt.dataset.price = s.sellPrice;
            select.appendChild(opt);
          });
        }).getMasterLayanan();
        
        document.getElementById('form-create-order').addEventListener('submit', this.handleCreateOrder);
      },

      updatePriceInfo: function(select) {
        const opt = select.options[select.selectedIndex];
        const price = opt.dataset.price || 0;
        document.getElementById('co-price-display').value = 'Rp ' + parseInt(price).toLocaleString();
      },

      handleCreateOrder: function(e) {
        e.preventDefault();
        const order = {
          device: document.getElementById('co-device').value,
          keluhan: document.getElementById('co-issue').value,
          layananId: document.getElementById('co-service').value,
          namaPelanggan: App.data.user.nama,
          noHP: '-' // Bisa ambil dari profil user jika ada field NoHP di USER
        };
        
        App.showLoader(true);
        google.script.run.withSuccessHandler(res => {
          App.showLoader(false);
          App.toast(res.message, res.status);
          if(res.status === 'success') App.loadUserDashboard();
        }).createOrder(order, App.data.user.id);
      },

      loadUserHistory: function() {
        this.setPageTitle('Riwayat Servis');
        document.getElementById('main-content-area').innerHTML = '<div id="history-container" class="card"></div>';
        // Reuse the table renderer but show all history
        this.loadOrdersTable('history-container', 50);
      },

      // --- HELPERS ---
      setPageTitle: function(title) {
        document.getElementById('page-title').textContent = title;
      },
      
      showLoader: function(show) {
        const el = document.getElementById('loader');
        if(show) el.classList.remove('hidden');
        else el.classList.add('hidden');
      },
      
      toast: function(msg, type='success') {
        const container = document.getElementById('toast-container');
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        div.textContent = msg;
        container.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      }
    };

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    // Initialize App
    document.addEventListener('DOMContentLoaded', () => {
      App.init();
    });

  </script>
</body>
</html>

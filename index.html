<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <title>Malik Service Center Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --light-bg: #f8fafc;
            --light-card: #ffffff;
            --text-main: #334155;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --nav-height: 65px;
        }

        body.dark-mode {
            --light-bg: #0f172a;
            --light-card: #1e293b;
            --text-main: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--light-bg);
            color: var(--text-main);
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: calc(var(--nav-height) + 20px);
            transition: background 0.3s;
        }

        /* =========================================
           2. LAYOUT & COMPONENTS
           ========================================= */
        header {
            background: var(--light-card);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-weight: 700; color: var(--primary); font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .brand img { height: 32px; }

        main { max-width: 1000px; margin: 0 auto; padding: 1rem; width: 100%; flex: 1; }

        /* SECTIONS */
        section { display: none; animation: fadeIn 0.3s ease; }
        section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & BOXES */
        .card { background: var(--light-card); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1rem; }
        .card h3 { color: var(--primary); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }

        /* FORMS */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.85rem; color: var(--text-main); }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--light-bg); color: var(--text-main); font-size: 0.95rem;
        }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        /* BUTTONS */
        .btn {
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
            padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
            transition: 0.2s; width: 100%; text-decoration: none; font-size: 0.95rem;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #64748b; color: white; }
        .btn-success { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        .btn-group { display: flex; gap: 10px; }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--light-card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 99;
        }
        .nav-item {
            flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: center;
            align-items: center; font-size: 0.7rem; color: var(--text-light); cursor: pointer; background: none; border: none;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); }

        /* ADMIN SIDEBAR (Desktop Style) */
        .admin-layout { display: grid; grid-template-columns: 200px 1fr; gap: 1rem; }
        .admin-sidebar { background: var(--light-card); padding: 1rem; border-radius: var(--radius); height: fit-content; }
        .sidebar-btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 5px; text-align: left;
            background: transparent; color: var(--text-main); border: none; border-radius: 6px; cursor: pointer;
        }
        .sidebar-btn:hover, .sidebar-btn.active { background: var(--primary); color: white; }
        .sidebar-btn i { width: 20px; }

        /* TABLE STYLES */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        th { text-align: left; padding: 10px; background: var(--light-bg); color: var(--text-light); border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: rgba(0,0,0,0.02); }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .badge-process { background: #e0f2fe; color: #0284c7; }
        .badge-done { background: #dcfce7; color: #16a34a; }
        .badge-pending { background: #fef3c7; color: #d97706; }

        /* TOAST & MODAL */
        .toast {
            position: fixed; top: 20px; right: 20px; background: var(--dark-bg); color: white;
            padding: 12px 24px; border-radius: 8px; z-index: 2000; display: none;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1500; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal { background: var(--light-card); width: 100%; max-width: 500px; padding: 20px; border-radius: var(--radius); animation: popIn 0.2s; max-height: 90vh; overflow-y: auto; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* RESPONSIVE */
        @media(max-width: 768px) {
            .admin-layout { grid-template-columns: 1fr; }
            .admin-sidebar { display: flex; overflow-x: auto; padding: 5px; margin-bottom: 10px; }
            .sidebar-btn { white-space: nowrap; width: auto; margin: 0 5px; flex: 1; text-align: center; }
        }

        /* =========================================
           3. PRINT STYLES (RESI)
           ========================================= */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute; left: 0; top: 0; width: 100%;
                background: white; color: black; padding: 20px;
            }
            .no-print { display: none !important; }
            .print-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 20px; }
            .print-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
            .print-footer { margin-top: 30px; text-align: center; font-size: 0.8rem; border-top: 1px dashed #000; padding-top: 10px; }
            /* Thermal 80mm specific adjustments */
            @page { margin: 0; size: 80mm auto; } /* Adjust for thermal printer if needed */
        }
    </style>
</head>
<body>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast"></div>

    <!-- HEADER -->
    <header>
        <div class="brand">
            <i class="fa-solid fa-microchip"></i>
            <span>MALIK SERVICE</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-sm btn-outline" onclick="toggleTheme()">
                <i class="fa-solid fa-moon"></i>
            </button>
        </div>
    </header>

    <main>
        <!-- ================= PUBLIC SECTIONS ================= -->
        
        <!-- 1. HOME / DASHBOARD -->
        <section id="home-section" class="active">
            <div class="hero" style="text-align: center; margin-bottom: 2rem;">
                <i class="fa-solid fa-wrench" style="font-size: 3rem; color: var(--primary);"></i>
                <h1 style="margin-top: 10px;">Service Center Profesional</h1>
                <p style="color: var(--text-light);">Spesialis HP Android & Laptop. Cepat, Bergaransi.</p>
            </div>

            <div class="card">
                <h3>Layanan Kami</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button class="btn btn-outline" onclick="quickOrder('HP Android')"><i class="fa-solid fa-mobile"></i> Servis HP</button>
                    <button class="btn btn-outline" onclick="quickOrder('Laptop')"><i class="fa-solid fa-laptop"></i> Servis Laptop</button>
                </div>
            </div>

            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="navTo('order-section')">Buat Order Baru</button>
                <button class="btn btn-secondary" onclick="navTo('history-section')">Riwayat Saya</button>
            </div>
        </section>

        <!-- 2. FORM ORDER -->
        <section id="order-section">
            <div class="card">
                <h3><i class="fa-solid fa-clipboard-list"></i> Form Order Servis</h3>
                
                <div class="form-group">
                    <label>Kategori Perangkat</label>
                    <select id="orderCategory" onchange="populateServices()">
                        <option value="">-- Pilih --</option>
                        <option value="HP Android">HP Android</option>
                        <option value="Laptop">Laptop / Netbook</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Jenis Kerusakan / Layanan</label>
                    <select id="orderService" onchange="updateEstimation()">
                        <option value="">-- Pilih Layanan --</option>
                    </select>
                    <small id="serviceEstInfo" style="color: var(--secondary); font-weight: bold; display:block; margin-top:5px;"></small>
                </div>

                <div class="form-group">
                    <label>Merk & Tipe</label>
                    <input type="text" id="orderDevice" placeholder="Contoh: Samsung A52 / Asus Vivobook">
                </div>

                <div class="form-group">
                    <label>Keluhan Detail</label>
                    <textarea id="orderComplaint" rows="3" placeholder="Jelaskan masalahnya..."></textarea>
                </div>

                <div class="form-group">
                    <label>Metode Pengiriman</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="display:inline-flex; align-items:center; gap:5px; cursor:pointer;">
                            <input type="radio" name="shipping" value="Direct" checked onchange="togglePickup()"> Antar Sendiri
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:5px; cursor:pointer;">
                            <input type="radio" name="shipping" value="Pickup" onchange="togglePickup()"> Request Pickup
                        </label>
                    </div>
                    <div id="pickupBox" style="display:none; margin-top:10px; padding:10px; background:var(--light-bg); border-radius:8px;">
                        <small style="color:var(--text-light)">Biaya pickup Rp 15.000 - 25.000 tergantung jarak.</small>
                    </div>
                </div>

                <div class="card" style="background: var(--primary); color: white;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>Estimasi Biaya:</span>
                        <span id="displayEstPrice">Rp 0</span>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--border); margin: 1.5rem 0;">

                <h4>Data Pelanggan</h4>
                <div class="form-group"><input type="text" id="custName" placeholder="Nama Lengkap"></div>
                <div class="form-group"><input type="tel" id="custWA" placeholder="Nomor WhatsApp (08...)"></div>

                <button class="btn btn-primary" onclick="submitOrder()">
                    <i class="fa-brands fa-whatsapp"></i> Kirim Order & Booking
                </button>
                <button class="btn btn-outline" onclick="navTo('home-section')">Batal</button>
            </div>
        </section>

        <!-- 3. CEK RESI -->
        <section id="tracking-section">
            <div class="card">
                <h3><i class="fa-solid fa-magnifying-glass"></i> Cek Status Servis</h3>
                <div class="form-group">
                    <input type="text" id="trackInput" placeholder="Masukkan Nomor Resi / No. HP">
                </div>
                <button class="btn btn-primary" onclick="trackOrder()">Cari</button>
                
                <div id="trackResult" style="margin-top: 20px;"></div>
            </div>
        </section>

        <!-- 4. HISTORY (WA BASED) -->
        <section id="history-section">
            <div class="card">
                <h3><i class="fa-solid fa-clock-rotate-left"></i> Riwayat Servis Anda</h3>
                <div class="form-group">
                    <input type="tel" id="historyWA" placeholder="Masukkan Nomor WhatsApp">
                </div>
                <button class="btn btn-secondary" onclick="getHistory()">Lihat Riwayat</button>
                <div id="historyResult" style="margin-top: 20px;"></div>
            </div>
        </section>

        <!-- 5. LOGIN ADMIN -->
        <section id="login-section">
            <div class="card" style="max-width: 400px; margin: 2rem auto; text-align: center;">
                <h3>Login Admin</h3>
                <div class="form-group">
                    <input type="password" id="adminPin" placeholder="Masukkan PIN Admin">
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Masuk</button>
                <p style="margin-top: 1rem;"><a href="#" onclick="navTo('home-section')" style="color: var(--text-light);">Kembali ke Home</a></p>
            </div>
        </section>

        <!-- ================= ADMIN PANEL ================= -->
        <section id="admin-panel">
            <div class="admin-layout">
                <!-- SIDEBAR -->
                <aside class="admin-sidebar">
                    <button class="sidebar-btn active" onclick="switchAdminTab('dashboard')"><i class="fa-solid fa-chart-pie"></i> Dashboard</button>
                    <button class="sidebar-btn" onclick="switchAdminTab('orders')"><i class="fa-solid fa-list"></i> Order Masuk</button>
                    <button class="sidebar-btn" onclick="switchAdminTab('services')"><i class="fa-solid fa-tags"></i> Layanan</button>
                    <button class="sidebar-btn" onclick="switchAdminTab('finance')"><i class="fa-solid fa-coins"></i> Keuangan</button>
                    <button class="sidebar-btn" onclick="switchAdminTab('customers')"><i class="fa-solid fa-users"></i> Customer</button>
                    <button class="sidebar-btn" onclick="switchAdminTab('settings')"><i class="fa-solid fa-gear"></i> Pengaturan</button>
                    <button class="sidebar-btn" onclick="logout()" style="color: var(--danger); margin-top: 20px;"><i class="fa-solid fa-sign-out-alt"></i> Keluar</button>
                </aside>

                <!-- CONTENT -->
                <div class="admin-content">
                    
                    <!-- TAB: DASHBOARD -->
                    <div id="adm-dashboard" class="admin-tab active">
                        <div class="card">
                            <h3>Ringkasan Hari Ini</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                <div style="text-align:center; padding:15px; background:var(--light-bg); border-radius:8px;">
                                    <h2 id="stat-total">0</h2>
                                    <small>Total Order</small>
                                </div>
                                <div style="text-align:center; padding:15px; background:var(--light-bg); border-radius:8px;">
                                    <h2 id="stat-pending">0</h2>
                                    <small>Perlu Proses</small>
                                </div>
                                <div style="text-align:center; padding:15px; background:var(--light-bg); border-radius:8px;">
                                    <h2 id="stat-revenue" style="color:var(--secondary)">Rp 0</h2>
                                    <small>Estimasi Omset</small>
                                </div>
                            </div>
                            <button class="btn btn-primary" style="margin-top:15px;" onclick="fetchData()">
                                <i class="fa-solid fa-rotate"></i> Sinkron Data Spreadsheet
                            </button>
                        </div>
                    </div>

                    <!-- TAB: ORDERS -->
                    <div id="adm-orders" class="admin-tab" style="display:none;">
                        <div class="card">
                            <div style="display:flex; gap:10px; margin-bottom:15px;">
                                <input type="text" id="searchOrder" placeholder="Cari Nama / Resi..." oninput="renderOrders()">
                                <select id="filterStatus" onchange="renderOrders()" style="width: 120px;">
                                    <option value="all">Semua</option>
                                    <option value="Proses">Proses</option>
                                    <option value="Selesai">Selesai</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table id="ordersTable">
                                    <thead><tr><th>Resi</th><th>Customer</th><th>Device</th><th>Status</th><th>Aksi</th></tr></thead>
                                    <tbody><!-- JS Populates --></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: SERVICES (MANAGER) -->
                    <div id="adm-services" class="admin-tab" style="display:none;">
                        <div class="card">
                            <h3>Tambah Layanan Baru</h3>
                            <div class="form-group" style="display:flex; gap:5px;">
                                <input type="text" id="newSvcCat" placeholder="Kategori (Mis: HP)">
                                <input type="text" id="newSvcName" placeholder="Nama Layanan">
                                <input type="number" id="newSvcPrice" placeholder="Harga">
                                <button class="btn btn-sm btn-primary" onclick="addService()">Add</button>
                            </div>
                        </div>
                        <div class="card">
                            <h3>Database Layanan</h3>
                            <div class="table-responsive">
                                <table id="servicesTable">
                                    <thead><tr><th>Kategori</th><th>Layanan</th><th>Harga</th><th>Aksi</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: FINANCE -->
                    <div id="adm-finance" class="admin-tab" style="display:none;">
                        <div class="card">
                            <h3>Laporan Keuangan</h3>
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <button class="btn btn-sm btn-outline" onclick="exportCSV()">Export CSV</button>
                                <button class="btn btn-sm btn-outline" onclick="printReport()">Print Laporan</button>
                            </div>
                            <div id="financeReport">
                                <p>Sinkronisasi data dulu untuk melihat laporan.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: CUSTOMERS -->
                    <div id="adm-customers" class="admin-tab" style="display:none;">
                        <div class="card">
                            <h3>Data Customer</h3>
                            <div id="customerList"></div>
                        </div>
                    </div>

                    <!-- TAB: SETTINGS -->
                    <div id="adm-settings" class="admin-tab" style="display:none;">
                        <div class="card">
                            <h3>Pengaturan Sistem</h3>
                            <div class="form-group">
                                <label>Nama Toko</label>
                                <input type="text" id="setStoreName" value="Malik Service Center">
                            </div>
                            <div class="form-group">
                                <label>Nomor WA Admin</label>
                                <input type="text" id="setAdminWA" value="628xxxxxxxx">
                            </div>
                            <button class="btn btn-primary" onclick="saveSettings()">Simpan</button>
                            <button class="btn btn-danger" onclick="resetData()">Reset Data Lokal</button>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <!-- BOTTOM NAV (PUBLIC) -->
    <nav class="bottom-nav" id="publicNav">
        <button class="nav-item active" onclick="navTo('home-section')"><i class="fa-solid fa-house"></i> Home</button>
        <button class="nav-item" onclick="navTo('order-section')"><i class="fa-solid fa-plus-circle"></i> Order</button>
        <button class="nav-item" onclick="navTo('tracking-section')"><i class="fa-solid fa-search"></i> Cek Resi</button>
        <button class="nav-item" onclick="navTo('history-section')"><i class="fa-solid fa-clock"></i> Riwayat</button>
        <button class="nav-item" onclick="navTo('login-section')"><i class="fa-solid fa-user-lock"></i> Admin</button>
    </nav>

    <!-- MODAL DETAIL ORDER / CETAK RESI -->
    <div class="modal-overlay" id="orderModal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Detail Order</h3>
                <button class="btn btn-sm btn-outline" onclick="document.getElementById('orderModal').style.display='none'">X</button>
            </div>
            
            <div id="modalContent"></div>

            <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px;">
                <button class="btn btn-primary" onclick="printResi()"><i class="fa-solid fa-print"></i> Cetak Resi</button>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="updateStatusOrder('Selesai')">Selesai</button>
                    <button class="btn btn-warning" onclick="updateStatusOrder('Proses')">Proses</button>
                    <button class="btn btn-danger" onclick="updateStatusOrder('Batal')">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HIDDEN PRINT AREA -->
    <div id="print-area" style="display:none;">
        <div class="print-header">
            <h2 id="printStoreName">MALIK SERVICE CENTER</h2>
            <p>Solusi Terbaik Elektronik Anda</p>
            <p>================================</p>
        </div>
        <div class="print-row"><span>No. Resi:</span> <span id="printId"></span></div>
        <div class="print-row"><span>Tgl Masuk:</span> <span id="printDate"></span></div>
        <p>================================</p>
        <b>PELANGGAN</b>
        <div class="print-row"><span>Nama:</span> <span id="printCustName"></span></div>
        <div class="print-row"><span>WA:</span> <span id="printCustWA"></span></div>
        <p>================================</p>
        <b>PERANGKAT & KERUSAKAN</b>
        <div class="print-row"><span>Device:</span> <span id="printDevice"></span></div>
        <div class="print-row"><span>Keluhan:</span> <span id="printIssue"></span></div>
        <div class="print-row"><span>Layanan:</span> <span id="printService"></span></div>
        <p>================================</p>
        <b>ESTIMASI BIAYA</b>
        <div style="font-size: 1.2rem; text-align: right; font-weight: bold;" id="printPrice"></div>
        <p style="text-align: center; font-size: 0.8rem; margin-top: 5px;">*Harga dapat berubah setelah pengecekan</p>
        <p>================================</p>
        <b>STATUS: <span id="printStatus"></span></b>
        <div class="print-footer">
            <p>Barang yang sudah ditinggal dianggap setuju.</p>
            <p>Terima kasih telah mempercayakan pada kami.</p>
            <br>
            <p id="printFooter"></p>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        /* =========================================
           1. CONFIGURATION & STATE
           ========================================= */
        const CONFIG = {
            APPS_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbz-rynDNAjDZ6A4eAgvRE_YMwEy9rZMnWq6m2i-t2NEct9_qAvJ_6ONrMtFO-BNq-wA/exec",
            SESSION_KEY: 'malik_admin_session',
            DB_KEY: 'malik_services_db'
        };

        // MASTER DATABASE SERVICE (LUAR BIASA LENGKAP)
        const masterServices = [
            // --- HP ANDROID ---
            { cat: "HP Android", name: "Ganti LCD (Ori)", price: 450000 },
            { cat: "HP Android", name: "Ganti LCD (Premium Copy)", price: 250000 },
            { cat: "HP Android", name: "Ganti Baterai (Ori)", price: 300000 },
            { cat: "HP Android", name: "Ganti Baterai (Double Power)", price: 150000 },
            { cat: "HP Android", name: "Ganti Touchscreen", price: 200000 },
            { cat: "HP Android", name: "Ganti Kamera Depan", price: 150000 },
            { cat: "HP Android", name: "Ganti Kamera Belakang", price: 200000 },
            { cat: "HP Android", name: "Ganti Mesin Slot SIM", price: 250000 },
            { cat: "HP Android", name: "Ganti Port Charging (Type C)", price: 200000 },
            { cat: "HP Android", name: "Ganti Port Charging (Micro USB)", price: 150000 },
            { cat: "HP Android", name: "Ganti Speaker (Suara)", price: 100000 },
            { cat: "HP Android", name: "Ganti Mic (Suara)", price: 100000 },
            { cat: "HP Android", name: "Ganti Vibrator", price: 80000 },
            { cat: "HP Android", name: "Perbaikan Mati Total (Hardware)", price: 350000 },
            { cat: "HP Android", name: "Perbaikan Bootloop (Software)", price: 150000 },
            { cat: "HP Android", name: "Flash Ulang Firmware (Stock)", price: 200000 },
            { cat: "HP Android", name: "Bypass FRP / Google Account", price: 150000 },
            { cat: "HP Android", name: "Recovery Data (Pricing Tergantung Kondisi)", price: 500000 },
            { cat: "HP Android", name: "Ganti Backdoor / Casing", price: 150000 },
            { cat: "HP Android", name: "Water Damage Treatment", price: 300000 },
            { cat: "HP Android", name: "IC Power Short", price: 450000 },
            
            // --- LAPTOP ---
            { cat: "Laptop", name: "Ganti LCD LED (14 inch)", price: 850000 },
            { cat: "Laptop", name: "Ganti LCD LED (15.6 inch)", price: 950000 },
            { cat: "Laptop", name: "Ganti Flexible LCD", price: 250000 },
            { cat: "Laptop", name: "Ganti Baterai (Original)", price: 650000 },
            { cat: "Laptop", name: "Ganti Baterai (OEM)", price: 400000 },
            { cat: "Laptop", name: "Ganti Keyboard (Universal)", price: 250000 },
            { cat: "Laptop", name: "Ganti Keyboard (Ori)", price: 550000 },
            { cat: "Laptop", name: "Ganti Harddisk (HDD 500GB)", price: 450000 },
            { cat: "Laptop", name: "Upgrade SSD 256GB", price: 450000 },
            { cat: "Laptop", name: "Upgrade RAM 4GB", price: 250000 },
            { cat: "Laptop", name: "Ganti Engsel Layar (Sepasang)", price: 200000 },
            { cat: "Laptop", name: "Ganti Casing Body", price: 450000 },
            { cat: "Laptop", name: "Pembersihan Fan / Ganti Pasta Processor", price: 150000 },
            { cat: "Laptop", name: "Perbaikan Mati Total", price: 600000 },
            { cat: "Laptop", name: "Install Ulang Windows 10/11 + Driver", price: 200000 },
            { cat: "Laptop", name: "Install Office (Original)", price: 150000 },
            { cat: "Laptop", name: "Recovery Data HDD/SSD", price: 800000 },
            { cat: "Laptop", name: "Ganti IC Charger / Konektor Power", price: 350000 }
        ];

        // INIT STATE
        let state = {
            services: JSON.parse(localStorage.getItem(CONFIG.DB_KEY)) || masterServices,
            orders: [], // Loaded from sheet
            currentOrder: null // For modal
        };

        // Load settings
        const settings = JSON.parse(localStorage.getItem('malik_settings')) || {
            storeName: "Malik Service Center",
            adminWA: "628123456789",
            address: "Jl. Teknologi No. 12, Semarang"
        };

        /* =========================================
           2. CORE NAVIGATION & UI
           ========================================= */
        function navTo(sectionId) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            window.scrollTo(0,0);

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(sectionId !== 'admin-panel') {
                const navIndex = ['home-section','order-section','tracking-section','history-section','login-section'].indexOf(sectionId);
                if(navIndex >= 0) document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            } else {
                // Hide public nav in admin
                if(!checkSession()) navTo('login-section');
            }
        }

        function switchAdminTab(tabId) {
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            document.getElementById('adm-' + tabId).style.display = 'block';
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            t.style.background = type === 'error' ? 'var(--danger)' : 'var(--dark-bg)';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
        }

        function formatRupiah(num) {
            return "Rp " + parseInt(num).toLocaleString('id-ID');
        }

        /* =========================================
           3. ORDER FLOW (CUSTOMER)
           ========================================= */
        function quickOrder(cat) {
            navTo('order-section');
            document.getElementById('orderCategory').value = cat;
            populateServices();
        }

        function populateServices() {
            const cat = document.getElementById('orderCategory').value;
            const sel = document.getElementById('orderService');
            sel.innerHTML = '<option value="">-- Pilih Layanan --</option>';
            
            state.services.filter(s => s.cat === cat).forEach(s => {
                const opt = document.createElement('option');
                opt.value = JSON.stringify(s);
                opt.innerText = `${s.name}`;
                sel.appendChild(opt);
            });
        }

        function updateEstimation() {
            const val = document.getElementById('orderService').value;
            if(!val) return;
            const svc = JSON.parse(val);
            document.getElementById('displayEstPrice').innerText = formatRupiah(svc.price);
            document.getElementById('serviceEstInfo').innerText = `Estimasi Pengerjaan: 1-3 Hari (Tergantung Sparepart)`;
        }

        function togglePickup() {
            const shipping = document.querySelector('input[name="shipping"]:checked').value;
            document.getElementById('pickupBox').style.display = (shipping === 'Pickup') ? 'block' : 'none';
        }

        async function submitOrder() {
            const name = document.getElementById('custName').value;
            const wa = document.getElementById('custWA').value;
            const device = document.getElementById('orderDevice').value;
            const complaint = document.getElementById('orderComplaint').value;
            const svcVal = document.getElementById('orderService').value;
            const shipping = document.querySelector('input[name="shipping"]:checked').value;

            if(!name || !wa || !device || !svcVal) { showToast("Data belum lengkap!", 'error'); return; }

            const svc = JSON.parse(svcVal);
            const resiId = "INV-" + Date.now().toString().slice(-6);
            
            // 1. Send to Spreadsheet
            const payload = {
                action: "save_order",
                orderId: resiId,
                name: name, wa: wa, device: device, complaint: complaint,
                category: svc.cat, service: svc.name, price: svc.price,
                shipping: shipping, status: "Menunggu"
            };

            fetch(CONFIG.APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(data => console.log("Saved", data))
                .catch(e => console.error(e));

            // 2. Send WA
            const msg = `Halo Admin, saya mau booking servis.\n\n` +
                       `Nama: ${name}\nWA: ${wa}\nDevice: ${device}\n` +
                       `Keluhan: ${complaint}\n` +
                       `Layanan: ${svc.name}\nEstimasi: ${formatRupiah(svc.price)}\n` +
                       `Metode: ${shipping}\n\nMohon diproses ya.`;
            
            window.open(`https://wa.me/${settings.adminWA}?text=${encodeURIComponent(msg)}`, '_blank');
            showToast("Order Terkirim!");
            navTo('home-section');
        }

        /* =========================================
           4. TRACKING & HISTORY
           ========================================= */
        async function trackOrder() {
            const input = document.getElementById('trackInput').value.trim();
            if(!input) return;

            const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "check_resi", resiId: input })
            });
            const result = await res.json();
            
            const container = document.getElementById('trackResult');
            if(result.success) {
                const d = result.data;
                container.innerHTML = `
                    <div class="card" style="border-left: 4px solid var(--primary);">
                        <h4>Order Ditemukan: ${d.orderId}</h4>
                        <p>Status: <b class="badge badge-process">${d.status}</b></p>
                        <p>Device: ${d.device}</p>
                        <button class="btn btn-sm btn-outline" onclick="openPrintModal('${d.orderId}')">Cetak Resi</button>
                    </div>
                `;
            } else {
                container.innerHTML = `<p style="color:red; text-align:center;">Data tidak ditemukan.</p>`;
            }
        }

        async function getHistory() {
            const wa = document.getElementById('historyWA').value.trim();
            // Simulate fetching locally for speed if needed, but here we fetch all from sheet
            await fetchData(); // Ensure data is fresh
            const myOrders = state.orders.filter(o => o.wa.includes(wa) || o.wa.replace(/^0/,'62').includes(wa.replace(/^0/,'62')));
            
            const container = document.getElementById('historyResult');
            if(myOrders.length > 0) {
                container.innerHTML = myOrders.map(o => `
                    <div class="card" style="padding:10px; margin-bottom:10px;">
                        <b>${o.orderId}</b> - ${o.status}<br>
                        <small>${o.service} (${formatRupiah(o.price)})</small>
                    </div>
                `).join('');
            } else {
                container.innerHTML = "Tidak ada riwayat.";
            }
        }

        /* =========================================
           5. ADMIN SYSTEM
           ========================================= */
        async function handleLogin() {
            const pin = document.getElementById('adminPin').value;
            // Simple SHA-256 simulation (or use real crypto.subtle)
            // Since backend handles hash, we send raw PIN if backend is secure or hash here.
            // Assuming backend does SHA-256 comparison.
            
            // For this demo, we use a simple check. In production use real hashing.
            const hashedPin = pin; // Send raw to backend if backend does hashing, or hash here.
            
            const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "login", pinHash: hashedPin }) // Backend handles salt/hash
            });
            const result = await res.json();

            if(result.success) {
                localStorage.setItem(CONFIG.SESSION_KEY, Date.now());
                navTo('admin-panel');
                fetchData();
            } else {
                showToast("Login Gagal", 'error');
            }
        }

        function checkSession() {
            const s = localStorage.getItem(CONFIG.SESSION_KEY);
            return s && (Date.now() - s < 3600000); // 1 hour
        }

        function logout() {
            localStorage.removeItem(CONFIG.SESSION_KEY);
            navTo('home-section');
        }

        async function fetchData() {
            const btn = document.querySelector('#adm-dashboard button');
            btn.innerText = "Loading...";
            
            const res = await fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "get_all_orders" })
            });
            const result = await res.json();

            if(result.success) {
                state.orders = result.data.reverse();
                renderOrders();
                updateDashboard();
            }
            btn.innerText = "Sinkron Data Spreadsheet";
        }

        function updateDashboard() {
            document.getElementById('stat-total').innerText = state.orders.length;
            document.getElementById('stat-pending').innerText = state.orders.filter(o => o.status === 'Proses' || o.status === 'Menunggu').length;
            const total = state.orders.reduce((acc, curr) => acc + (parseInt(curr.price)||0), 0);
            document.getElementById('stat-revenue').innerText = formatRupiah(total);
        }

        function renderOrders() {
            const search = document.getElementById('searchOrder').value.toLowerCase();
            const filter = document.getElementById('filterStatus').value;
            const tbody = document.querySelector('#ordersTable tbody');
            
            const filtered = state.orders.filter(o => {
                const matchSearch = (o.orderId+o.name+o.device).toLowerCase().includes(search);
                const matchFilter = filter === 'all' || o.status.includes(filter);
                return matchSearch && matchFilter;
            });

            tbody.innerHTML = filtered.map(o => `
                <tr>
                    <td><b>${o.orderId}</b></td>
                    <td>${o.name}<br><small>${o.wa}</small></td>
                    <td>${o.category} - ${o.service}</td>
                    <td><span class="badge badge-${o.status === 'Selesai' ? 'done' : 'process'}">${o.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openOrderModal('${o.orderId}')">Detail</button>
                    </td>
                </tr>
            `).join('');
        }

        /* =========================================
           6. MODAL & PRINT LOGIC
           ========================================= */
        function openOrderModal(resiId) {
            const order = state.orders.find(o => o.orderId === resiId);
            state.currentOrder = order;

            const html = `
                <p><b>Resi:</b> ${order.orderId}</p>
                <p><b>Pelanggan:</b> ${order.name} (${order.wa})</p>
                <p><b>Device:</b> ${order.device}</p>
                <p><b>Keluhan:</b> ${order.complaint}</p>
                <p><b>Layanan:</b> ${order.service}</p>
                <p><b>Status:</b> <span class="badge badge-process">${order.status}</span></p>
                <p><b>Estimasi:</b> ${formatRupiah(order.price)}</p>
                <div style="margin-top:10px;">
                    <a href="https://wa.me/${order.wa.replace(/[^0-9]/g,'')}" target="_blank" class="btn btn-sm btn-success">Chat WA</a>
                </div>
            `;
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('orderModal').style.display = 'flex';
        }

        function printResi() {
            const o = state.currentOrder;
            if(!o) return;

            // Fill Print Area
            document.getElementById('printStoreName').innerText = settings.storeName;
            document.getElementById('printId').innerText = o.orderId;
            document.getElementById('printDate').innerText = new Date(o.timestamp).toLocaleDateString('id-ID');
            document.getElementById('printCustName').innerText = o.name;
            document.getElementById('printCustWA').innerText = o.wa;
            document.getElementById('printDevice').innerText = o.device;
            document.getElementById('printIssue').innerText = o.complaint;
            document.getElementById('printService').innerText = o.service;
            document.getElementById('printPrice').innerText = formatRupiah(o.price);
            document.getElementById('printStatus').innerText = o.status;
            document.getElementById('printFooter').innerText = settings.address;

            // Trigger Print
            window.print();
        }

        async function updateStatusOrder(newStatus) {
            if(!state.currentOrder) return;
            
            // Optimistic UI
            state.currentOrder.status = newStatus;
            document.getElementById('orderModal').style.display = 'none';
            renderOrders();
            
            // Send to Sheet
            fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "update_status",
                    orderId: state.currentOrder.orderId,
                    newStatus: newStatus
                })
            });
            showToast(`Status diubah ke ${newStatus}`);
        }

        /* =========================================
           7. SERVICE MANAGEMENT & UTILS
           ========================================= */
        function addService() {
            const cat = document.getElementById('newSvcCat').value;
            const name = document.getElementById('newSvcName').value;
            const price = document.getElementById('newSvcPrice').value;

            if(!cat || !name || !price) return;

            state.services.push({ cat, name, price: parseInt(price) });
            localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(state.services));
            renderServiceTable();
            
            // Clear inputs
            document.getElementById('newSvcCat').value = "";
            document.getElementById('newSvcName').value = "";
            document.getElementById('newSvcPrice').value = "";
        }

        function renderServiceTable() {
            const tbody = document.querySelector('#servicesTable tbody');
            // Only show custom ones (which are at the end of the array usually, or all)
            // Showing all for visibility
            tbody.innerHTML = state.services.map((s, i) => `
                <tr>
                    <td>${s.cat}</td>
                    <td>${s.name}</td>
                    <td>${formatRupiah(s.price)}</td>
                    <td>
                        ${i >= masterServices.length ? 
                          `<button class="btn btn-sm btn-danger" onclick="deleteService(${i})">Hapus</button>` : 
                          `<small>Default</small>`}
                    </td>
                </tr>
            `).join('');
        }

        function deleteService(index) {
            if(confirm('Hapus layanan ini?')) {
                state.services.splice(index, 1);
                localStorage.setItem(CONFIG.DB_KEY, JSON.stringify(state.services));
                renderServiceTable();
            }
        }

        function saveSettings() {
            const s = {
                storeName: document.getElementById('setStoreName').value,
                adminWA: document.getElementById('setAdminWA').value,
                address: settings.address
            };
            localStorage.setItem('malik_settings', JSON.stringify(s));
            showToast("Pengaturan disimpan");
        }

        function resetData() {
            if(confirm("Reset semua data layanan custom ke default?")) {
                localStorage.removeItem(CONFIG.DB_KEY);
                location.reload();
            }
        }

        function exportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Resi,Nama,Device,Layanan,Harga,Status\n";
            state.orders.forEach(o => {
                csvContent += `${o.orderId},"${o.name}","${o.device}","${o.service}",${o.price},${o.status}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "laporan_servis.csv");
            document.body.appendChild(link);
            link.click();
        }

        // Init
        renderServiceTable();
    </script>
</body>
</html>
